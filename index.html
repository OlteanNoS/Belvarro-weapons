
<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>FiveM Craft Calculator</title>

<!-- FontAwesome (pentru coș) -->
<link
  defer
  media="print"
  onload="this.media='all'"
  rel="stylesheet"
  href="https://site-assets.fontawesome.com/releases/v7.2.0/css/all.css"
/>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  :root{
    --bg-url: url("https://i.imgur.com/fTp0NnE.png"); /* Shop background */
    --green:#2ecc71;
    --panel:#141414;
    --panel2:#101010;
    --border:#2a2a2a;
    --text:#ffffff;
    --muted: rgba(255,255,255,.75);
    --shadow: 0 18px 70px rgba(0,0,0,.55);
  }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
        -webkit-appearance: none;
    }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: Arial, sans-serif;
    color:var(--text);
    min-height:100vh;
    display:flex;
    justify-content:center;
    padding:20px;
    background:#0d0d0d;
    position:relative;
    overflow-x:hidden;
    background-image: url("https://i.imgur.com/hdGnzUT.jpg");
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
  }
  body::before{
    content:"";
    position:fixed;
    inset:0;
    filter: blur(2px) saturate(1.1);
    transform: scale(1.04);
    z-index:-2;
  }
  body::after{
    content:"";
    position:fixed;
    inset:0;
    background:
      radial-gradient(900px 500px at 20% 0%, rgba(46,204,113,.10), transparent 60%),
      radial-gradient(700px 420px at 85% 10%, rgba(52,152,219,.10), transparent 60%),
      linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.90));
    z-index:-1;
  }

  .container{
    width:1000px;
    max-width:100%;
    height: 950px;
    max-height: 950px;
    background: rgba(0,0,0,0.82);
    border:1px solid rgba(255,255,255,0.08);
    border-radius:16px;
    padding:18px;
    backdrop-filter: blur(7px);
    box-shadow: var(--shadow);
    overflow-y: scroll;
    display: none;
  }

  .imagine {
    background-image: url("https://i.imgur.com/hjouzE0.png");
    background-size: 50%;
    background-position: center;
    background-repeat: no-repeat;
    position: absolute;
    top: 1vh;
    left: -3.5vw;
    width: 15vw;
    height: 15vh;
    opacity: .8;
  }

  .container::-webkit-scrollbar {
    display: none;
  }

  /* Top tabs */
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:12px;
    flex-wrap:wrap;
  }
  .tabs{
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
  }
  .tab{
    cursor:pointer;
    border:1px solid var(--border);
    background: rgba(18,18,18,.85);
    color:#fff;
    border-radius:999px;
    padding:8px 12px;
    font-weight:900;
    opacity:.9;
    transition:.18s;
    user-select:none;
  }
  .tab:hover{transform: translateY(-1px); opacity:1;}
  .tab.active{
    border-color: rgba(46,204,113,.85);
    box-shadow: 0 0 0 2px rgba(46,204,113,.12) inset;
  }
  .topActions{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
  .tinyBtn{
    cursor:pointer;
    border:1px solid var(--border);
    background: rgba(18,18,18,.85);
    color:#fff;
    border-radius:10px;
    padding:8px 10px;
    font-weight:900;
    transition:.18s;
  }
  .tinyBtn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.18);}

  h3{margin:10px 0 10px;}
  .box{
    background: rgba(16,16,16,0.85);
    border:1px solid rgba(255,255,255,0.08);
    border-radius:16px;
    padding:14px;
    box-shadow: 0 10px 40px rgba(0,0,0,.25);
  }

  .field{
    display:flex;
    align-items:center;
    gap:12px;
    margin:10px 0;
    flex-wrap:wrap;
  }
  .field label{
    width:220px;
    max-width:100%;
    opacity:.9;
  }
  .field select,.field input, .modalControls input{
    flex:1;
    min-width:240px;
    padding:10px;
    font-size:14px;
    border-radius:12px;
    border:1px solid #444;
    background:#141414;
    color:#fff;
    transition:.18s;
  }
  .field select:focus,.field input:focus, .modalControls input:focus{
    outline:none;
    border-color:var(--green);
    box-shadow: 0 0 0 3px rgba(46,204,113,.12);
  }

  .row{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }

  .btn{
    cursor:pointer;
    border:none;
    border-radius:12px;
    padding:10px 12px;
    font-weight:900;
    color:#fff;
    background:var(--green);
    transition:.18s;
  }
  .btn:hover{background:#27ae60; transform: translateY(-1px);}
  .btn:active{transform: translateY(0px) scale(.99);}
  .btn.secondary{
    background:#141414;
    border:1px solid var(--border);
    font-weight:900;
  }
  .btn.secondary:hover{background:#1b1b1b;}
  .btn.danger{background:#c0392b;}
  .btn.danger:hover{background:#a93226;}

  /* Select weapon button */
  .btn.selectWeapon{
    width:100%;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    background:#141414;
    border:1px solid var(--border);
    overflow:hidden;
    position:relative;
  }
  .btn.selectWeapon::after{
    content:"";
    position:absolute;
    inset:-2px;
    background: linear-gradient(90deg, rgba(46,204,113,.15), rgba(52,152,219,.10), transparent);
    opacity:.35;
    pointer-events:none;
    transform: translateX(-35%);
    transition:.35s;
  }
  .btn.selectWeapon:hover::after{transform: translateX(0%); opacity:.5;}
  .btn.selectWeapon .left{
    display:flex;
    align-items:center;
    gap:10px;
    min-width:0;
  }
  .btn.selectWeapon img{
    flex: 0 0 44px;
    width:44px;height:44px;
    border-radius:12px;
    object-fit:contain;
    object-position:center;
    border:1px solid var(--border);
    background:#0f0f0f;
  }
  .btn.selectWeapon .title{
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width: 700px;
  }
  .chev{opacity:.6;font-weight:900;}
  .selectHint{
    display:flex;
    justify-content:flex-end;
    margin-top:8px;
    gap:8px;
  }
  .selectPill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.10);
    background: rgba(0,0,0,.20);
    opacity:.85;
    user-select:none;
  }
  .dot{
    width:8px;height:8px;border-radius:999px;background: var(--green);
    box-shadow: 0 0 0 6px rgba(46,204,113,.14);
  }

  .step{
    overflow:hidden;
    max-height:0;
    opacity:0;
    transform: translateY(-6px);
    transition:max-height .35s ease, opacity .25s ease, transform .25s ease;
    border-left:3px solid transparent;
    padding-left:0;
    margin-top:0;
  }
  .step.show{
    max-height:2600px;
    opacity:1;
    transform: translateY(0);
    border-left-color:var(--green);
    padding-left:12px;
    margin-top:12px;
  }

  .attachments{margin-top:10px;}
  .attach{margin:8px 0;}
  .attach label{cursor:pointer;}
  .attach input{transform: translateY(1px); accent-color:var(--green);}

  .result{
    margin-top:14px;
    padding:14px;
    border-radius:16px;
    background:#101010;
    border:1px solid var(--border);
    display:none;
    box-shadow: 0 16px 50px rgba(0,0,0,.35);
  }

  .grid{
    display:grid;
  }
  @media (max-width: 900px){
    .grid{grid-template-columns:1fr;}
    .field select,.field input,.modalControls input{min-width:0; width:100%;}
    .field label{width:100%;}
    .btn.selectWeapon .title{max-width: 62vw;}
  }

  hr{border:0; border-top:1px solid var(--border); margin:12px 0;}
  .muted{opacity:.75;}

  /* Cart */
  .cartList{margin-top:10px; display:flex; flex-direction:column; gap:10px;}
  .cartItem{
    border:1px solid var(--border);
    background:#101010;
    border-radius:16px;
    padding:12px;
  }
  .cartTitle{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
  .cartMeta{display:flex; gap:8px; flex-wrap:wrap;}
  .mini{font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--border); background:#161616;}
  .cartItem img{
    display:block;
    object-fit:contain !important;
    object-position:center;
    background:#0f0f0f;
  }

  /* MODAL WEAPON PICKER */
  .modalOverlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.72);
    display:none;
    justify-content:center;
    padding:16px;
    z-index:999;
  }
  .modalOverlay.show{display:flex;}
  .modal{
    width:min(1040px, 98vw);
    max-height:min(86vh, 860px);
    overflow:hidden;
    border-radius:18px;
    margin-top: 60px;
    border:1px solid rgba(255,255,255,0.10);
    background: rgba(12,12,12,0.96);
    backdrop-filter: blur(10px);
    display:flex;
    flex-direction:column;
    box-shadow: var(--shadow);
    transform: translateY(8px);
    opacity:0;
    animation: pop .18s ease forwards;
  }
  @keyframes pop{ to { transform: translateY(0); opacity:1; } }
  .modalHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:14px;
    border-bottom:1px solid rgba(255,255,255,0.06);
  }
  .modalHeader .title{font-size:16px;font-weight:900;}
  .modalHeader .x{
    cursor:pointer;
    border:1px solid var(--border);
    background:#141414;
    color:#fff;
    border-radius:12px;
    padding:8px 10px;
    font-weight:900;
  }
  .modalHeader .x:hover{background:#1b1b1b;}
  .modalControls{
    padding:14px;
    border-bottom:1px solid rgba(255,255,255,0.06);
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .pill{
    cursor:pointer;
    padding:8px 12px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#141414;
    font-weight:900;
    opacity:.9;
    user-select:none;
    transition:.18s;
  }
  .pill:hover{background:#1b1b1b; transform: translateY(-1px);}
  .pill.active{
    border-color:var(--green);
    box-shadow: 0 0 0 2px rgba(46,204,113,.15) inset;
  }
  .modalBody{padding:14px; overflow:auto;}

  .weaponGrid{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:12px;
  }
  @media (max-width: 980px){ .weaponGrid{grid-template-columns: repeat(3, 1fr);} }
  @media (max-width: 700px){ .weaponGrid{grid-template-columns: repeat(2, 1fr);} }

  .wCard{
    border:1px solid var(--border);
    background:#101010;
    border-radius:18px;
    overflow:hidden;
    transition:.18s;
    display:flex;
    flex-direction:column;
    min-height:180px;
  }
  .wImg{
    height:118px;
    width:100%;
    background:#0f0f0f;
    object-fit:contain;
    object-position:center;
    display:block;
    image-rendering:auto;
  }
  .wInfo{padding:10px; display:flex; flex-direction:column; gap:8px;}
  .wName{font-weight:900; font-size:13px; line-height:1.2;}
  .wMetaRow{display:flex; gap:6px; flex-wrap:wrap; align-items:center; justify-content:space-between;}
  .tag{font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid var(--border); background:#141414; opacity:.85;}
  .selBtn{
    cursor:pointer;
    border:1px solid rgba(46,204,113,.35);
    background: rgba(46,204,113,.14);
    color:#fff;
    padding:6px 10px;
    border-radius:10px;
    font-weight:900;
    transition:.18s;
  }
  .selBtn:hover{background: rgba(46,204,113,.22); transform: translateY(-1px);}

  /* Material cards */
  .matGrid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:10px;
  }
  @media (max-width: 900px){ .matGrid{grid-template-columns: repeat(2, 1fr);} }
  .matCard{
    border:1px solid var(--border);
    background: #0f0f0f;
    border-radius:16px;
    padding:10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    min-height:56px;
  }
  .matLeft{display:flex; align-items:center; gap:10px; min-width:0;}
  .matLeft img{
    width:34px;height:34px;
    border-radius:12px;
    border:1px solid var(--border);
    background:#0b0b0b;
    object-fit:cover;
  }
  .matName{
    font-weight:900;
    font-size:13px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .matBadge{
    min-width:44px;
    text-align:center;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#141414;
    font-weight:900;
  }

  /* Tooltip preview */
  .tooltip{
    position:fixed;
    z-index:1200;
    pointer-events:none;
    background: rgba(10,10,10,.96);
    border:1px solid rgba(255,255,255,.10);
    border-radius:14px;
    padding:10px 12px;
    box-shadow: 0 16px 50px rgba(0,0,0,.55);
    width: min(340px, 80vw);
    display:none;
  }
  .tooltip.show{display:block;}
  .tipTitle{font-weight:900; margin-bottom:6px;}
  .tipRow{display:flex; justify-content:space-between; gap:10px; opacity:.92; font-size:13px;}
  .tipSmall{opacity:.72; font-size:12px; margin-top:6px;}

  /* Lightbox */
  .lightbox{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background: rgba(0,0,0,.82);
    z-index:1300;
    padding:16px;
  }
  .lightbox.show{display:flex;}
  .lbInner{
    width:min(860px, 95vw);
    border-radius:18px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(12,12,12,.96);
    overflow:hidden;
    box-shadow: var(--shadow);
  }
  .lbHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:12px 14px;
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  .lbHeader b{font-size:14px;}
  .lbClose{
    cursor:pointer;
    border:1px solid var(--border);
    background:#141414;
    color:#fff;
    border-radius:10px;
    width: 35px;
    height: 35px;
    font-weight:900;
  }
  .lbClose:hover{background:#1b1b1b;}
  .lbImgWrap{
    padding:16px;
    display:flex;
    justify-content:center;
    align-items:center;
  }
  .lbImg{
    width: min(760px, 90vw);
    max-height:70vh;
    object-fit:contain;
    background:#0f0f0f;
    border-radius:16px;
    border:1px solid var(--border);
  }

  /* Slot UI */
  .slotWrap{display:flex; flex-direction:column; gap:10px; margin-top:10px;}
  .slotCard{
    border:1px solid var(--border);
    background:#0f0f0f;
    border-radius:16px;
    padding:10px;
  }
  .slotHeader{
    display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;
    margin-bottom:8px;
  }
  .slotTitle{font-weight:900;}
  .slotChips{display:flex; gap:6px; flex-wrap:wrap;}
  .slotOpt{
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.10);
    background:#141414;
    transition:.18s;
    user-select:none;
  }
  .slotOpt:hover{background:#1b1b1b; transform: translateY(-1px);}
  .slotOpt.active{
    border-color: rgba(46,204,113,.75);
    box-shadow: 0 0 0 2px rgba(46,204,113,.10) inset;
    background: rgba(46,204,113,.10);
  }
  .slotOpt .miniIcon{
    width:24px; height:24px;
    border-radius:10px;
    border:1px solid var(--border);
    background:#0b0b0b;
    object-fit:cover;
  }

  /* Page switch */
  .page{display:none;}
  .page.show{display:block;}

  /* Smooth entrance */
  .fadeIn{
    animation: fadeIn .22s ease both;
  }
  @keyframes fadeIn{ from {opacity:0; transform: translateY(8px);} to {opacity:1; transform: translateY(0);} }
</style>
</head>
<body onclick="openGunModal()">
      <div class="imagine"></div>
      <div class="container" id="weaponContainer">
      <div class="topbar">
        <div class="tabs">
          <div class="tab active" data-page="pageWeapons">Arme</div>
          <div class="tab" data-page="pageAmmo">Gloanțe</div>
        </div>
        <div class="topActions" style="display: none;">
          <button class="tinyBtn" id="copyLinkBtn" type="button">Copiază link</button>
        </div>
      </div>

      <!-- =========================
          PAGE: WEAPONS
      ========================== -->
      <div class="page show fadeIn" id="pageWeapons">

        <!-- STEP 1 -->
        <div class="box">
          <h3 style="margin-top:0;">Ce vrei să craftezi?</h3>

          <div class="field">
            <label>Arma:</label>

            <button class="btn selectWeapon" id="openWeaponModalBtn" type="button">
              <span class="left">
                <img id="selectedWeaponImg" alt="" />
                <span class="title" id="selectedWeaponLabel">-- Selectează arma --</span>
              </span>
              <span class="chev">▾</span>
            </button>

            <!-- dropdown ascuns (păstrat pentru logică) -->
            <select id="weaponSelect" style="display:none;">
              <option value="">-- Selectează arma --</option>
            </select>
          </div>

          <div class="selectHint">
            <span class="selectPill"><span class="dot"></span>Selectează</span>
          </div>
        </div>

        <!-- STEP 2 -->
        <div class="step" id="bulletsStep">
          <div class="box">
            <h3 style="margin-top:0;">Gloanțe</h3>
            <div class="field">
              <label for="bulletsSelect">Cantitate:</label>
              <select id="bulletsSelect"></select>
            </div>
            <div class="muted" id="ammoHint"></div>
          </div>
        </div>

        <!-- STEP 3 -->
        <div class="step" id="attachmentsStep">
          <div class="box">
            <div class="row" style="justify-content:space-between;">
              <h3 style="margin:0;">Atașamente</h3>
              <div class="row" style="gap:10px;">
                <label style="opacity:.85;">
                  <input type="checkbox" id="noAttach" style="accent-color: var(--green);" />
                  Fără atașamente
                </label>
                <label style="opacity:.85; display: none;">
                  <input type="checkbox" id="slotMode" checked />
                  Sloturi
                </label>
              </div>
            </div>

            <!-- Slot mode -->
            <div id="slotModeWrap" class="slotWrap"></div>

            <!-- List mode (legacy) -->
            <div class="attachments" id="attachmentsList" style="display:none;"></div>
            <div style="opacity:.75;" id="attachmentsHint"></div>
          </div>
        </div>

        <!-- STEP 4 -->
        <div class="step" id="qtyStep">
          <div class="box">
            <h3 style="margin-top:0;">Cantitate</h3>
            <div class="field">
              <label for="qty">Număr arme:</label>
              <input type="number" id="qty" min="1" value="1"/>
            </div>

            <div class="row">
              <button class="btn" id="calcBtn" type="button">Calculează</button>
              <button class="btn secondary" id="addToCartBtn" type="button">Adaugă în coș</button>
            </div>
          </div>
        </div>

        <div id="result" class="result"></div>

        <!-- CART -->
        <div class="box" style="margin-top:14px;">
          <div class="row" style="justify-content:space-between;">
            <h3 style="margin:0;">
              <i class="fa-solid fa-basket-shopping"></i>
              Coș
            </h3>
            <div class="row">
              <button class="btn secondary" id="calcCartBtn" type="button">Calculează coș</button>
              <button class="btn danger" id="clearCartBtn" type="button">Golește coș</button>
            </div>
          </div>
          <div id="cartList" class="cartList"></div>
          <div id="cartResult" class="result" style="display:none;"></div>
        </div>

      </div>

      <!-- =========================
          PAGE: AMMO ONLY
      ========================== -->
      <div class="page" id="pageAmmo">
        <div class="box">
          <h3 style="margin-top:0;">Calculator gloanțe</h3>
          <div class="field">
            <label>Arma:</label>
            <select id="ammoWeaponSelect"></select>
          </div>
          <div class="field">
            <label>Cantitate:</label>
            <select id="ammoOnlyBullets"></select>
          </div>

          <div class="result" id="ammoOnlyResult" style="display:block;">
            <div class="row" style="align-items:center; gap:12px;">
              <img id="ammoOnlyImg" alt="" style="width:70px;height:70px;border-radius:16px;object-fit:contain;border:1px solid var(--border);background:#0f0f0f;">
              <div style="min-width:0;">
                <div style="font-size:16px;font-weight:900;" id="ammoOnlyName">—</div>
                <div class="muted" id="ammoOnlyMeta">—</div>
              </div>
            </div>
            <hr>
            <div class="grid">
              <div class="box">
                <h3 style="margin-top:0;">Necesare</h3>
                <div class="matGrid" id="ammoOnlyMats"></div>
              </div>
              <br>
              <div class="box">
                <h3 style="margin-top:0;">Cost</h3>
                <div style="font-size:22px;font-weight:900;" id="ammoOnlyCost">0$</div>
                <div class="muted" id="ammoOnlyPowder">0 praf</div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- TOOLTIP preview -->
    <div class="tooltip" id="tooltip">
      <div class="tipTitle" id="tipTitle"></div>
      <div class="tipRow"><span class="muted">Tip</span><b id="tipType"></b></div>
      <div class="tipRow"><span class="muted">Cost (1 armă + 100 gl)</span><b id="tipCost"></b></div>
      <div class="tipRow"><span class="muted">Praf (100 gl)</span><b id="tipPowder"></b></div>
      <div class="tipSmall" id="tipMats"></div>
    </div>

    <!-- LIGHTBOX zoom -->
    <div class="lightbox" id="lightbox">
      <div class="lbInner">
        <div class="lbHeader">
          <b id="lbTitle">Preview</b>
          <button class="lbClose" id="lbClose" type="button">✕</button>
        </div>
        <div class="lbImgWrap">
          <img class="lbImg" id="lbImg" alt="">
        </div>
      </div>
    </div>

    <!-- MODAL WEAPON PICKER -->
    <div class="modalOverlay" id="weaponModal">
      <div class="modal" role="dialog" aria-modal="true" aria-label="Alege arma">
        <div class="modalHeader">
          <div class="title">Alege arma</div>
          <button class="x" id="closeWeaponModalBtn" type="button">✕</button>
        </div>

        <div class="modalControls">
          <input id="modalSearch" type="text" placeholder="Caută armă..." style="flex:1; min-width:240px;"/>
          <div class="row">
            <div class="pill active" data-cat="ALL">Toate</div>
            <div class="pill" data-cat="Pistoale">Pistoale</div>
            <div class="pill" data-cat="SMG">SMG</div>
            <div class="pill" data-cat="Rifle">Rifle</div>
            <div class="pill" data-cat="OFICIALA">OFICIALA</div>
          </div>
        </div>

        <div class="modalBody">
          <div class="weaponGrid" id="weaponGrid"></div>
          <div class="muted" id="weaponGridEmpty" style="display:none; padding:10px;">Niciun rezultat.</div>
        </div>
      </div>
    </div>

<script>
/* =========================
   COSTURI materiale
========================= */
const COST_STEEL = 5000;
const COST_POLYMER = 150;
// șuruburi: 20 = 1 oțel
function costFromScrews(totalScrews){ return Math.floor((totalScrews||0)/20) * COST_STEEL; }
// țeavă component: 1 țeavă = 4 oțel
function costFromBarrels(totalBarrels){ return (totalBarrels||0) * 4 * COST_STEEL; }

/* =========================
   ICONS materiale
========================= */
const materialIcons = {
  steel:   "https://assetsfivem.fplayt.ro/images/gui/images/items/steel.webp",
  screw:   "https://assetsfivem.fplayt.ro/images/gui/images/items/bolts.webp",
  barrel:  "https://assetsfivem.fplayt.ro/images/gui/images/items/barrel.webp",
  spring:  "https://assetsfivem.fplayt.ro/images/gui/images/items/arcmetalic.webp",
  wood:    "https://assetsfivem.fplayt.ro/images/gui/images/items/wood.webp",
  polymer: "https://assetsfivem.fplayt.ro/images/gui/images/items/polimer.webp",
  bec:     "https://assetsfivem.fplayt.ro/images/gui/images/items/bec.webp",
  lupa:    "https://assetsfivem.fplayt.ro/images/gui/images/items/lupa.webp",
  powder:  "https://assetsfivem.fplayt.ro/images/gui/images/items/copper.webp"
};
const materialLabels = {
  steel:"Oțel", screw:"Șuruburi", barrel:"Țeavă", spring:"Arc", wood:"Lemn",
  polymer:"Polimer", bec:"Bec", lupa:"Lupă", powder:"Praf de pușcă"
};
/* Ordine afișare (powder inclus) */
const materialOrder = ["steel","screw","barrel","spring","wood","polymer","bec","lupa","powder"];

/* =========================
   BULLETS OPTIONS 100..2000
========================= */
const BULLET_OPTIONS = [];
for(let b=100;b<=2000;b+=100) BULLET_OPTIONS.push(b);

/* =========================
   AMMO TABLE - exact + interpolare
========================= */
const ammoTable = {
  "PISTOL":                    [{b:100,powder:100,price:5400},{b:200,powder:200,price:10666},{b:250,powder:250,price:13333}],
  "COMBAT PISTOL":             [{b:100,powder:100,price:5400},{b:200,powder:200,price:10700},{b:250,powder:250,price:13400}],
  "PISTOL MK2":                [{b:100,powder:130,price:7000},{b:200,powder:260,price:13900},{b:250,powder:325,price:17400}],
  "CERAMIC PISTOL":            [{b:100,powder:130,price:7000},{b:200,powder:260,price:13900},{b:250,powder:325,price:17400}],
  "PISTOL WM29 (XM3)":         [{b:100,powder:130,price:7000},{b:200,powder:260,price:13900},{b:250,powder:325,price:17400}],

  "MICRO SMG":                 [{b:100,powder:150,price:8000},{b:200,powder:300,price:16000},{b:250,powder:375,price:20000}],
  "MACHINE PISTOL (Tec9)":     [{b:100,powder:150,price:8000},{b:200,powder:300,price:16000},{b:250,powder:375,price:20000}],
  "MINI SMG":                  [{b:100,powder:150,price:8000},{b:200,powder:300,price:16000},{b:250,powder:375,price:20000}],

  "TEC PISTOL (Tactical SMG)": [{b:100,powder:180,price:10000},{b:200,powder:360,price:19000},{b:250,powder:450,price:24000}],
  "SMG":                       [{b:100,powder:180,price:10000},{b:200,powder:360,price:19000},{b:250,powder:450,price:24000}],
  "COMBAT PDW":                [{b:100,powder:180,price:10000},{b:200,powder:360,price:19000},{b:250,powder:450,price:24000}],

  "ASSAULT RIFLE (AK)":        [{b:100,powder:250,price:13400},{b:200,powder:500,price:26700},{b:250,powder:625,price:33400}],
  "COMPACT RIFLE":             [{b:100,powder:250,price:13400},{b:200,powder:500,price:26700},{b:250,powder:625,price:33400}],
  "CARABINE RIFLE":            [{b:100,powder:300,price:16000},{b:200,powder:600,price:32000},{b:250,powder:750,price:40000}],
  "ADVANCED RIFLE":            [{b:100,powder:300,price:16000},{b:200,powder:600,price:32000},{b:250,powder:750,price:40000}],

  "NAVY REVOLVER":             [{b:100,powder:500,price:26700},{b:200,powder:1000,price:54000},{b:250,powder:1250,price:66700}],
  "VINTAGE PISTOL":            [{b:100,powder:150,price:8000},{b:200,powder:300,price:16000},{b:250,powder:375,price:20000}],
  "DB":                        [{b:100,powder:500,price:26700},{b:200,powder:1000,price:54000},{b:250,powder:1250,price:66700}],
  "ASSAULT RIFLE MK2":         [{b:100,powder:300,price:16000},{b:200,powder:600,price:32000},{b:250,powder:750,price:40000}],
  "HEAVY RIFLE":               [{b:100,powder:300,price:16000},{b:200,powder:600,price:32000},{b:250,powder:750,price:40000}],
  "COMBAT MG MK2":             [{b:100,powder:300,price:16000},{b:200,powder:600,price:32000},{b:250,powder:750,price:40000}],
  "GUSENBERG":                 [{b:100,powder:180,price:9600},{b:200,powder:360,price:19000},{b:250,powder:450,price:24000}],
  "MG":                        [{b:100,powder:300,price:16000},{b:200,powder:600,price:32000},{b:250,powder:750,price:40000}],
};
function lerp(a,b,t){ return a + (b-a)*t; }
function ammoExactInterpolated(weaponName, bullets){
  const pts = ammoTable[weaponName];
  if(!pts) return {powder:0, price:0};
  const p100=pts[0], p200=pts[1], p250=pts[2];

  if(bullets===100) return {powder:p100.powder, price:p100.price};
  if(bullets===200) return {powder:p200.powder, price:p200.price};
  if(bullets===250) return {powder:p250.powder, price:p250.price};

  if(bullets <= 200){
    const t=(bullets-100)/(200-100);
    return {powder:lerp(p100.powder,p200.powder,t), price:lerp(p100.price,p200.price,t)};
  }
  if(bullets <= 250){
    const t=(bullets-200)/(250-200);
    return {powder:lerp(p200.powder,p250.powder,t), price:lerp(p200.price,p250.price,t)};
  }
  // extrapolare după segmentul 200-250
  const slopePowder = (p250.powder - p200.powder) / (250-200);
  const slopePrice  = (p250.price  - p200.price ) / (250-200);
  const extra = bullets - 250;
  return {powder: p250.powder + slopePowder*extra, price: p250.price + slopePrice*extra};
}

/* =========================
   WEAPONS + ATTACHMENTS
   NOTE: Țeavă este component (materials.barrel), NU atașament.
   NOTE: Încărcător & Baterie = același slot (Magazin).
========================= */
function att(name, data){ return { name, data }; }
function emptyTotals(){ return {steel:0,screw:0,barrel:0,spring:0,wood:0,polymer:0,bec:0,lupa:0,powder:0}; }
function sumInto(dst, src, mult=1){
  Object.keys(src||{}).forEach(k=>{
    dst[k] = (dst[k]||0) + (src[k]||0) * mult;
  });
}
const weapons = [
  // CRAFT (ordinea ta)
  { name:"PISTOL", type:"craft", materials:{steel:8,screw:80,barrel:0,spring:1,wood:0,polymer:20},
    attachments:[ att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}), att("Amortizor",{steel:2,screw:5,polymer:2}), att("Încărcător",{steel:1,screw:5,spring:1,polymer:1}) ] },
  { name:"COMBAT PISTOL", type:"craft", materials:{steel:8,screw:85,barrel:0,spring:0,wood:0,polymer:18},
    attachments:[ att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}), att("Amortizor",{steel:2,screw:5,polymer:2}), att("Încărcător",{steel:1,screw:5,spring:1,polymer:1}) ] },
  { name:"PISTOL MK2", type:"craft", materials:{steel:9,screw:91,barrel:0,spring:1,wood:0,polymer:22},
    attachments:[ att("Încărcător",{steel:1,screw:5,spring:1,polymer:1}), att("Mounted-Scope",{steel:2,screw:10,polymer:2,lupa:1}), att("Amortizor",{steel:2,screw:5,polymer:2}), att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}) ] },
  { name:"CERAMIC PISTOL", type:"craft", materials:{steel:9,screw:91,barrel:0,spring:1,wood:0,polymer:18},
    attachments:[ att("Amortizor",{steel:2,screw:5,polymer:2}), att("Încărcător",{steel:1,screw:5,spring:1,polymer:1}) ] },
  { name:"PISTOL WM29 (XM3)", type:"craft", materials:{steel:10,screw:95,barrel:0,spring:1,wood:0,polymer:20},
    attachments:[ att("Amortizor",{steel:2,screw:5,polymer:2}) ] },

  { name:"MICRO SMG", type:"craft", materials:{steel:15,screw:95,barrel:1,spring:1,wood:0,polymer:42},
    attachments:[ att("Lunetă",{steel:2,screw:10,polymer:2,lupa:1}), att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}), att("Amortizor",{steel:3,screw:5,polymer:3}), att("Încărcător",{steel:2,screw:10,spring:1,polymer:2}) ] },
  { name:"MACHINE PISTOL (Tec9)", type:"craft", materials:{steel:12,screw:100,barrel:0,spring:1,wood:0,polymer:38},
    attachments:[ att("Amortizor",{steel:2,screw:5,polymer:2}), att("Încărcător",{steel:2,screw:8,spring:1,polymer:2}) ] },
  { name:"MINI SMG", type:"craft", materials:{steel:11,screw:97,barrel:0,spring:1,wood:1,polymer:36},
    attachments:[ att("Încărcător",{steel:2,screw:10,spring:1,polymer:2}) ] },
  { name:"TEC PISTOL (Tactical SMG)", type:"craft", materials:{steel:14,screw:115,barrel:1,spring:1,wood:0,polymer:44},
    attachments:[ att("Lunetă",{steel:2,screw:10,polymer:2,lupa:1}), att("Încărcător",{steel:2,screw:10,spring:1,polymer:2}), att("Suppresor-Muzzle-Brake",{steel:3,screw:5,polymer:3}) ] },
  { name:"SMG", type:"craft", materials:{steel:13,screw:105,barrel:1,spring:1,wood:0,polymer:48},
    attachments:[ att("Încărcător",{steel:2,screw:10,spring:1,polymer:2}), att("Baterie-Gloante",{steel:3,screw:20,spring:1,polymer:3}), att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}), att("Amortizor",{steel:3,screw:5,polymer:3}), att("Lunetă",{steel:2,screw:10,polymer:2,lupa:1}) ] },
  { name:"COMBAT PDW", type:"craft", materials:{steel:14,screw:110,barrel:1,spring:1,wood:0,polymer:50},
    attachments:[ att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}), att("Baterie-Gloante",{steel:3,screw:20,spring:1,polymer:3}), att("Lunetă",{steel:2,screw:10,polymer:2,lupa:1}), att("Încărcător",{steel:2,screw:10,spring:1,polymer:2}), att("Grip",{steel:1,screw:5,polymer:1}) ] },

  { name:"ASSAULT RIFLE (AK)", type:"craft", materials:{steel:21,screw:135,barrel:1,spring:2,wood:1,polymer:68},
    attachments:[ att("Lunetă",{steel:2,screw:10,polymer:2,lupa:1}), att("Baterie-Gloante",{steel:3,screw:20,spring:1,polymer:3}), att("Amortizor",{steel:3,screw:5,polymer:3}), att("Încărcător",{steel:2,screw:5,spring:1,polymer:2}), att("Grip",{steel:1,screw:5,polymer:1}), att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}) ] },
  { name:"COMPACT RIFLE", type:"craft", materials:{steel:19,screw:115,barrel:1,spring:2,wood:1,polymer:44},
    attachments:[ att("Încărcător",{steel:3,screw:30,spring:1,polymer:3}), att("Baterie-Gloante",{steel:3,screw:20,spring:1,polymer:3}) ] },
  { name:"CARABINE RIFLE", type:"craft", materials:{steel:18,screw:140,barrel:1,spring:2,wood:0,polymer:72},
    attachments:[ att("Grip",{steel:1,screw:5,polymer:1}), att("Încărcător",{steel:1,screw:5,spring:1,polymer:1}), att("Lunetă",{steel:2,screw:10,polymer:2,lupa:1}), att("Baterie-Gloante",{steel:3,screw:20,spring:1,polymer:3}), att("Amortizor",{steel:3,screw:5,polymer:3}), att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}) ] },
  { name:"ADVANCED RIFLE", type:"craft", materials:{steel:18,screw:145,barrel:1,spring:2,wood:0,polymer:78},
    attachments:[ att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}), att("Amortizor",{steel:3,screw:5,polymer:3}), att("Încărcător",{steel:1,screw:5,spring:1,polymer:1}), att("Lunetă",{steel:2,screw:10,polymer:2,lupa:1}) ] },

  // OFICIALA (pe bani) - ordinea ta
  { name:"NAVY REVOLVER", type:"money", price:400000, attachments:[] },
  { name:"VINTAGE PISTOL", type:"money", price:25000,
    attachments:[ att("Încărcător",{steel:1,screw:5,spring:1,polymer:1}), att("Amortizor",{steel:2,screw:5,polymer:2}) ] },
  { name:"DB", type:"money", price:250000, attachments:[] },

  { name:"ASSAULT RIFLE MK2", type:"money", price:70000,
    attachments:[
      att("Lunetă-Mica",{steel:2,screw:10,polymer:2,lupa:1}),
      att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}),
      att("Încărcător",{steel:2,screw:5,spring:1,polymer:2}),
      att("Lunetă-Mare",{steel:2,screw:12,polymer:2,lupa:1}),
      att("Grip",{steel:1,screw:5,polymer:1}),
      // Țeavă NU e atașament în UI, dar rămâne în date (se calculează ca material)
      att("Țeavă",{steel:4,screw:16,polymer:4}),
      att("Heavy Dutty Muzzle Brake",{steel:1,screw:4,polymer:1}),
      att("Vizor-Holografic",{steel:1,screw:8,polymer:1,lupa:1}),
      att("Flat-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Slanded-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Amortizor",{steel:3,screw:5,polymer:3}),
      att("Tactical-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Precision-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Split-End-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Fat-End-Muzzle-Brake",{steel:1,screw:4,polymer:1})
    ]},

  { name:"HEAVY RIFLE", type:"money", price:60000,
    attachments:[
      att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}),
      att("Încărcător",{steel:1,screw:5,spring:1,polymer:1}),
      att("Lunetă",{steel:2,screw:10,polymer:2,lupa:1}),
      att("Amortizor",{steel:3,screw:5,polymer:3}),
      att("Grip",{steel:1,screw:5,polymer:1})
    ]},

  { name:"COMBAT MG MK2", type:"money", price:120000,
    attachments:[
      att("Lunetă-Mare",{steel:2,screw:12,polymer:2,lupa:1}),
      att("Încărcător",{steel:1,screw:5,spring:1,polymer:1}),
      att("Grip",{steel:1,screw:5,polymer:1}),
      att("Lunetă-Medie",{steel:2,screw:10,polymer:2,lupa:1}),
      att("Țeavă",{steel:4,screw:16,polymer:4}),
      att("Vizor holografic",{steel:1,screw:8,polymer:1,lupa:1}),
      att("Slanded-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Fat-End-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Heavy Dutty-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Precision-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Tactical-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Flat-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Split-End-Muzzle-Brake",{steel:1,screw:4,polymer:1})
    ]},

  { name:"GUSENBERG", type:"money", price:45000, attachments:[] },
  { name:"MG", type:"money", price:90000, attachments:[] },
];

/* =========================
   CATEGORII (display)
========================= */
function categoryOf(name){
  const pistols = new Set(["PISTOL","COMBAT PISTOL","PISTOL MK2","CERAMIC PISTOL","PISTOL WM29 (XM3)","VINTAGE PISTOL","NAVY REVOLVER","DB"]);
  const smgs = new Set(["MICRO SMG","MACHINE PISTOL (Tec9)","MINI SMG","TEC PISTOL (Tactical SMG)","SMG","COMBAT PDW","GUSENBERG"]);
  const rifles = new Set(["ASSAULT RIFLE (AK)","COMPACT RIFLE","CARABINE RIFLE","ADVANCED RIFLE","ASSAULT RIFLE MK2","HEAVY RIFLE","COMBAT MG MK2","MG"]);
  if(pistols.has(name)) return "Pistoale";
  if(smgs.has(name)) return "SMG";
  if(rifles.has(name)) return "Rifle";
  return "Rifle";
}

/* =========================
   IMAGINI ARME
========================= */
const weaponImages = {
  "PISTOL": "http://assetsarena.fplayt.ro/images/weapons/Pistol.webp",
  "COMBAT PISTOL": "http://assetsarena.fplayt.ro/images/weapons/Combat_Pistol.webp",
  "PISTOL MK2": "http://assetsarena.fplayt.ro/images/weapons/Pistol_Mk_II.webp",
  "CERAMIC PISTOL": "http://assetsarena.fplayt.ro/images/weapons/Ceramic_Pistol.webp",
  "PISTOL WM29 (XM3)": "http://assetsarena.fplayt.ro/images/weapons/Pistol_XM3.webp",
  "MICRO SMG": "http://assetsarena.fplayt.ro/images/weapons/Micro_SMG.webp",
  "MACHINE PISTOL (Tec9)": "http://assetsarena.fplayt.ro/images/weapons/Machine_Pistol.webp",
  "MINI SMG": "http://assetsarena.fplayt.ro/images/weapons/Mini_SMG.webp",
  "TEC PISTOL (Tactical SMG)": "http://assetsarena.fplayt.ro/images/weapons/TEC_Pistol.webp",
  "SMG": "http://assetsarena.fplayt.ro/images/weapons/SMG.webp",
  "COMBAT PDW": "http://assetsarena.fplayt.ro/images/weapons/Combat_PDW.webp",
  "ASSAULT RIFLE (AK)": "http://assetsarena.fplayt.ro/images/weapons/Assault_Rifle.webp",
  "COMPACT RIFLE": "http://assetsarena.fplayt.ro/images/weapons/Compact_Rifle.webp",
  "CARABINE RIFLE": "http://assetsarena.fplayt.ro/images/weapons/Carbine_Rifle.webp",
  "ADVANCED RIFLE": "http://assetsarena.fplayt.ro/images/weapons/Advanced_Rifle.webp",

  "VINTAGE PISTOL": "http://assetsarena.fplayt.ro/images/weapons/Vintage_Pistol.webp",
  "DB": "http://assetsarena.fplayt.ro/images/weapons/Double_Action_Revolver.webp",
  "NAVY REVOLVER": "http://assetsarena.fplayt.ro/images/weapons/Navy_Revolver.webp",
  "ASSAULT RIFLE MK2": "http://assetsarena.fplayt.ro/images/weapons/Assault_Rifle_Mk_II.webp",
  "HEAVY RIFLE": "http://assetsarena.fplayt.ro/images/weapons/Heavy_Rifle.webp",
  "COMBAT MG MK2": "http://assetsarena.fplayt.ro/images/weapons/Combat_MG_Mk_II.webp",
  "GUSENBERG": "http://assetsarena.fplayt.ro/images/weapons/Gusenberg_Sweeper.webp",
  "MG": "http://assetsarena.fplayt.ro/images/weapons/MG.webp"
};
function imageForWeapon(name){
  return weaponImages[name] || "http://assetsarena.fplayt.ro/images/weapons/Pistol.webp";
}

/* =========================
   Attachment slots (categorii)
========================= */
function normalize(s){ return (s||"").toLowerCase(); }
function slotOfAttachmentName(attName){
  const n = normalize(attName);
  if(n.includes("lantern")) return "Lanternă";
  if(n.includes("lunet") || n.includes("scope") || n.includes("vizor")) return "Optică";
  if(n.includes("grip")) return "Grip";
  if(n.includes("amortiz") || n.includes("suppress") ) return "Amortizor";
  if(n.includes("muzzle") || n.includes("brake")) return "Muzzle";
  if(n.includes("încărc") || n.includes("incarc") || n.includes("baterie")) return "Magazin";
  if(n.includes("țeav") || n.includes("teava")) return "Component"; // nu o afișăm ca slot (doar pt safety)
  return "Altele";
}


/* =========================
   UI elements
========================= */
const tabs = [...document.querySelectorAll(".tab[data-page]")];
const pages = {
  pageWeapons: document.getElementById("pageWeapons"),
  pageAmmo: document.getElementById("pageAmmo")
};
const copyLinkBtn = document.getElementById("copyLinkBtn");

/* Weapons page */
const openWeaponModalBtn = document.getElementById("openWeaponModalBtn");
const selectedWeaponLabel = document.getElementById("selectedWeaponLabel");
const selectedWeaponImg = document.getElementById("selectedWeaponImg");
const weaponSelect = document.getElementById("weaponSelect");

const bulletsSelect = document.getElementById("bulletsSelect");
const slotModeToggle = document.getElementById("slotMode");
const slotModeWrap = document.getElementById("slotModeWrap");
const attachmentsList = document.getElementById("attachmentsList");
const noAttach = document.getElementById("noAttach");

const bulletsStep = document.getElementById("bulletsStep");
const attachmentsStep = document.getElementById("attachmentsStep");
const qtyStep = document.getElementById("qtyStep");

const ammoHint = document.getElementById("ammoHint");
const attachmentsHint = document.getElementById("attachmentsHint");

const qtyInput = document.getElementById("qty");
const calcBtn = document.getElementById("calcBtn");
const addToCartBtn = document.getElementById("addToCartBtn");
const resultDiv = document.getElementById("result");

const cartList = document.getElementById("cartList");
const cartResult = document.getElementById("cartResult");
const calcCartBtn = document.getElementById("calcCartBtn");
const clearCartBtn = document.getElementById("clearCartBtn");

const weaponModal = document.getElementById("weaponModal");
const weaponGrid = document.getElementById("weaponGrid");
const weaponGridEmpty = document.getElementById("weaponGridEmpty");
const modalSearch = document.getElementById("modalSearch");
const closeWeaponModalBtn = document.getElementById("closeWeaponModalBtn");
const pills = [...document.querySelectorAll(".pill[data-cat]")];

/* Tooltip + Lightbox */
const tooltip = document.getElementById("tooltip");
const tipTitle = document.getElementById("tipTitle");
const tipType = document.getElementById("tipType");
const tipCost = document.getElementById("tipCost");
const tipPowder = document.getElementById("tipPowder");
const tipMats = document.getElementById("tipMats");
const lightbox = document.getElementById("lightbox");
const lbImg = document.getElementById("lbImg");
const lbTitle = document.getElementById("lbTitle");
const lbClose = document.getElementById("lbClose");

/* Ammo page */
const ammoWeaponSelect = document.getElementById("ammoWeaponSelect");
const ammoOnlyBullets = document.getElementById("ammoOnlyBullets");
const ammoOnlyImg = document.getElementById("ammoOnlyImg");
const ammoOnlyName = document.getElementById("ammoOnlyName");
const ammoOnlyMeta = document.getElementById("ammoOnlyMeta");
const ammoOnlyMats = document.getElementById("ammoOnlyMats");
const ammoOnlyCost = document.getElementById("ammoOnlyCost");
const ammoOnlyPowder = document.getElementById("ammoOnlyPowder");

/* =========================
   helpers
========================= */
function hide(el){ el.classList.remove("show"); }
function show(el){ el.classList.add("show"); }
function money(n){ return Math.round(n||0).toLocaleString() + "$"; }

function openGunModal() {
  document.getElementById("weaponContainer").style.display = "block";
}

function resetFlow(){
  hide(bulletsStep); hide(attachmentsStep); hide(qtyStep);
  resultDiv.style.display="none";
  bulletsSelect.innerHTML = "";
  slotModeWrap.innerHTML = "";
  attachmentsList.innerHTML = "";
  ammoHint.textContent = "";
  attachmentsHint.textContent = "";
  noAttach.checked = false;
}

function fillBullets(selectEl){
  selectEl.innerHTML="";
  BULLET_OPTIONS.forEach(b=>{
    const opt=document.createElement("option");
    opt.value=String(b);
    opt.textContent=`${b} gloanțe`;
    selectEl.appendChild(opt);
  });
}

/* =========================
   cost materiale (fără praf)
========================= */
function estimateMaterialsCost(t){
  let cost=0;
  cost += (t.steel||0)*COST_STEEL;
  cost += costFromScrews(t.screw||0);
  cost += costFromBarrels(t.barrel||0);
  cost += (t.polymer||0)*COST_POLYMER;
  // arc + lemn + bec + lupă: infim (0)
  return cost;
}

/* =========================
   compute
========================= */
function computeOneSelection(sel){
  const w=weapons[sel.weaponIndex];
  const qty=Math.max(1, sel.qty||1);
  const bullets=sel.bullets||100;

  const baseTotals=emptyTotals();
  const attTotals=emptyTotals();
  const ammoTotals=emptyTotals();
  const grandTotals=emptyTotals();

  let costWeapon=0;
  let costAmmo=0;

  if(w.type==="craft"){
    sumInto(baseTotals, w.materials, qty);
  }else{
    costWeapon = (w.price||0)*qty;
  }

  const ammoOne=ammoExactInterpolated(w.name, bullets);
  ammoTotals.powder += (ammoOne.powder||0)*qty;
  costAmmo += (ammoOne.price||0)*qty;

  if(w.attachments && w.attachments.length && !sel.noAttach){
    (sel.selectedAtt||[]).forEach(i=>{
      const a=w.attachments[i];
      if(!a||!a.data) return;
      // nu afișăm țeavă ca atașament, dar dacă există în tabel, o calculăm (devine material)
      // (practic e ok să fie contabilizată)
      sumInto(attTotals, a.data, qty);
    });
  }

  sumInto(grandTotals, baseTotals, 1);
  sumInto(grandTotals, attTotals, 1);
  sumInto(grandTotals, ammoTotals, 1);

  const costMats=estimateMaterialsCost(grandTotals);
  const total=Math.round(costWeapon + costAmmo + costMats);

  return {w, qty, bullets, baseTotals, attTotals, ammoTotals, grandTotals, costWeapon, costAmmo, costMats, total};
}

function currentSelectionToObject(){
  const idx = weaponSelect.value;
  if(idx==="") return null;
  const w = weapons[Number(idx)];

  const qty=Math.max(1, parseInt(qtyInput.value||"1",10));
  const bullets=parseInt(bulletsSelect.value||"100",10);

  let selectedAtt=[];
  if(w.attachments && w.attachments.length && !noAttach.checked){
    selectedAtt = getSelectedAttachmentsFromSlots(w);
  }
  return {weaponIndex:Number(idx), bullets, qty, noAttach:!!noAttach.checked, selectedAtt};
}

/* =========================
   Materials rendering (ascunde zero)
========================= */
function matCardHTML(key, value){
  const v = Math.round(value || 0);
  if(v<=0) return ""; // ✅ nu arătăm materialele cu 0
  return `
    <div class="matCard">
      <div class="matLeft">
        <img src="${materialIcons[key]||""}" alt="${materialLabels[key]||key}">
        <div class="matName">${materialLabels[key]||key}</div>
      </div>
      <div class="matBadge">${v}</div>
    </div>
  `;
}
function compactLineFromTotals(tot){
  const parts=[];
  materialOrder.forEach(k=>{
    const v=Math.round(tot[k]||0);
    if(v>0) parts.push(`${materialLabels[k]} ${v}`);
  });
  return parts.length? parts.join(", ") : "—";
}

/* =========================
   Missing summary (include powder + cost ammo missing)
   - cost missing powder: unitPrice = ammoPrice / powder (pt selecția curentă)
========================= */
function computeMissingSummary(out, stock){
  const need = out.grandTotals;
  const miss = emptyTotals();
  materialOrder.forEach(k=>{
    const n = Math.round(need[k]||0);
    const h = Math.round(stock[k]||0);
    miss[k] = Math.max(0, n-h);
  });

  // cost missing materials (fără praf)
  const costMissingMats = Math.round(estimateMaterialsCost(miss));

  // cost missing ammo: proporțional din prețul gloanțelor selectate
  const ammoOne = ammoExactInterpolated(out.w.name, out.bullets);
  const unit = (ammoOne.powder>0) ? (ammoOne.price / ammoOne.powder) : 0;
  const costMissingAmmo = Math.round((miss.powder||0) * unit);

  return {miss, costMissingMats, costMissingAmmo, unit};
}

/* =========================
   RENDER result
========================= */
const STOCK_KEY="fivem_stock_v2";
function saveStock(stock){ localStorage.setItem(STOCK_KEY, JSON.stringify(stock)); }
function loadStock(){
  try{
    const raw=localStorage.getItem(STOCK_KEY);
    const obj=raw ? JSON.parse(raw) : null;
    if(!obj || typeof obj!=="object") return emptyTotals();
    const s=emptyTotals();
    materialOrder.forEach(k=> s[k]=Math.max(0, parseInt(obj[k]||0,10) || 0));
    return s;
  }catch(e){
    return emptyTotals();
  }
}
function readStockFromUI(root){
  const stock = emptyTotals();
  root.querySelectorAll("input[data-stock-key]").forEach(inp=>{
    const k = inp.getAttribute("data-stock-key");
    const n = Math.max(0, parseInt(inp.value||"0",10));
    stock[k]=n;
  });
  return stock;
}
function stockInputsHTML(values){
  return `
    <div class="matGrid">
      ${materialOrder.map(k=>{
        const v = Math.max(0, Math.round(values[k]||0));
        // ✅ arătăm și praf (ca să poată scădea la lipsuri)
        return `
          <div class="matCard">
            <div class="matLeft">
              <img src="${materialIcons[k]||""}" alt="${materialLabels[k]||k}">
              <div class="matName">${materialLabels[k]||k}</div>
            </div>
            <input
              inputmode="numeric"
              style="width: 50px; min-width: 50px; flex:0 0 auto; background: none; color: white; border:1px solid var(--border); border-radius:8px; padding:6px 3px; text-align: center;"
              type="number"
              class="stockInput"
              min="0"
              value="${v}"
              data-stock-key="${k}"
            />
          </div>
        `;
      }).join("")}
    </div>
  `;
}
function renderMissingGrid(miss){
  const cards = materialOrder.map(k=>matCardHTML(k, miss[k])).join("");
  return cards ? `<div class="matGrid">${cards}</div>` : `<div class="muted">Nu îți lipsește nimic.</div>`;
}

function renderResult(out, isPreview){
  resultDiv.style.display="block";

  const stockSaved = loadStock();
  const {miss, costMissingMats, costMissingAmmo} = computeMissingSummary(out, stockSaved);

  const totalNeedMats = Math.round(out.costMats);
  const totalNeedAmmo = Math.round(out.costAmmo);
  const totalNeedWeapon = Math.round(out.costWeapon);

  const totalMissing = Math.round(costMissingMats + costMissingAmmo + (out.w.type==="money" ? out.costWeapon : 0));

  const needCards = materialOrder.map(k=>matCardHTML(k, out.grandTotals[k])).join("");
  const needGrid = needCards ? `<div class="matGrid">${needCards}</div>` : `<div class="muted">—</div>`;

  resultDiv.innerHTML=`
    <h3>${isPreview ? "Preview" : "Rezultat"}</h3>

    <div class="grid">
      <div class="box">
        <div class="row" style="align-items:center; gap:12px;">
          <img src="${imageForWeapon(out.w.name)}" alt="${out.w.name}"
               style="width:74px;height:74px;border-radius:16px;object-fit:contain;border:1px solid var(--border);background:#0f0f0f;cursor:zoom-in;"
               id="resultWeaponImg">
          <div style="min-width:0;">
            <div style="font-size:16px;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
              ${out.w.name}
            </div>
            <div class="muted">${categoryOf(out.w.name)} • ${out.w.type==="craft" ? "Craft" : "OFICIALA"}</div>
            <div style="opacity:.9;margin-top:6px;">
              <b>Arme:</b> ${out.qty} • <b>Gloanțe:</b> ${out.bullets}
            </div>
          </div>
        </div>
      </div>
      <br>
      <div class="box">
        <div class="muted">Total (necesar)</div>
        <div style="font-size:22px;font-weight:900;">${money(out.total)}</div>
        <hr>
        <div><b>Cost armă:</b> ${money(totalNeedWeapon)}</div>
        <div><b>Cost gloanțe:</b> ${money(totalNeedAmmo)}</div>
        <div><b>Cost materiale:</b> ${money(totalNeedMats)}</div>
      </div>
    </div>

    <hr>

    <div class="grid">
      <div class="box" style="width:100%">
        <h3 style="margin-top:0;">Materiale (Total)</h3>
        ${needGrid}
      </div>
        <br>
      <div class="box" style="width:100%">
        <h3 style="margin-top:0;">Îți lipsesc (după stoc)</h3>
        <div class="muted" style="margin-bottom:10px;">Completează stocul mai jos.</div>

        <div id="stockInputsWrap">
          ${stockInputsHTML(stockSaved)}
        </div>

        <hr>

        <div id="missingGridWrap">
          ${renderMissingGrid(miss)}
        </div>

        <div class="muted" style="margin-top:10px;">
          <b>Cost lipsuri materiale:</b> ${money(costMissingMats)}<br>
          <b>Cost lipsuri gloanțe:</b> ${money(costMissingAmmo)}<br>
          <b>Total lipsuri:</b> ${money(totalMissing)}
        </div>
      </div>
    </div>
  `;

  // zoom
  const resImg = document.getElementById("resultWeaponImg");
  if(resImg){
    resImg.addEventListener("click", ()=> openLightbox(out.w.name, imageForWeapon(out.w.name)));
  }

  // stock live recalculation + persist
  const stockWrap = document.getElementById("stockInputsWrap");
  const missWrap = document.getElementById("missingGridWrap");

  stockWrap.querySelectorAll("input[data-stock-key]").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      if(parseInt(inp.value||"0",10)<0) inp.value="0";
      const currentStock = readStockFromUI(stockWrap);
      saveStock(currentStock);

      const {miss: missNow, costMissingMats: cM, costMissingAmmo: cA} = computeMissingSummary(out, currentStock);
      missWrap.innerHTML = renderMissingGrid(missNow);

      // update text (quick way: rerender the muted block by rerender full result)
      // but keep smooth: just update via small rerender
      const mutedBlock = stockWrap.parentElement.querySelector(".muted:last-of-type");
      if(mutedBlock){
        const totalMissingNow = Math.round(cM + cA + (out.w.type==="money" ? out.costWeapon : 0));
        mutedBlock.innerHTML = `
          <b>Cost lipsuri materiale:</b> ${money(cM)}<br>
          <b>Cost lipsuri gloanțe:</b> ${money(cA)}<br>
          <b>Total lipsuri:</b> ${money(totalMissingNow)}
        `;
      }
    });
  });

  // copy discord
  const copyBtn = document.getElementById("copyDiscordBtn");
  if(copyBtn){
    copyBtn.addEventListener("click", ()=>{
      const currentStock = readStockFromUI(stockWrap);
      const {miss: missNow, costMissingMats: cM, costMissingAmmo: cA} = computeMissingSummary(out, currentStock);

      const lines = [];
      lines.push(`**${out.w.name}** x${out.qty} • **${out.bullets} gl**`);
      lines.push(`Total necesar: **${out.total.toLocaleString()}$**`);
      lines.push(`—`);
      lines.push(`**Necesare:**`);
      materialOrder.forEach(k=>{
        const v = Math.round(out.grandTotals[k]||0);
        if(v>0) lines.push(`• ${materialLabels[k]}: **${v}**`);
      });
      lines.push(`—`);
      lines.push(`**Îți lipsesc (după stoc):**`);
      materialOrder.forEach(k=>{
        const v = Math.round(missNow[k]||0);
        if(v>0) lines.push(`• ${materialLabels[k]}: **${v}**`);
      });
      lines.push(`Cost lipsuri materiale: **${Math.round(cM).toLocaleString()}$**`);
      lines.push(`Cost lipsuri gloanțe: **${Math.round(cA).toLocaleString()}$**`);
      navigator.clipboard?.writeText(lines.join("\n"));
    });
  }

  const resetStockBtn = document.getElementById("resetStockBtn");
  if(resetStockBtn){
    resetStockBtn.addEventListener("click", ()=>{
      saveStock(emptyTotals());
      renderResult(out, isPreview);
    });
  }
}

/* =========================
   LIVE PREVIEW
========================= */
function updateLivePreview(){
  const sel=currentSelectionToObject();
  if(!sel) return;
  const out=computeOneSelection(sel);
  renderResult(out, true);
}

/* =========================
   populate hidden select + ammo page
========================= */
function buildWeaponSelect(){
  weaponSelect.innerHTML = `<option value="">-- Selectează arma --</option>`;
  weapons.forEach((w,idx)=>{
    const opt=document.createElement("option");
    opt.value=String(idx);
    opt.textContent=w.name;
    weaponSelect.appendChild(opt);
  });

  // ammo page weapon select
  ammoWeaponSelect.innerHTML = "";
  weapons.forEach((w,idx)=>{
    const opt=document.createElement("option");
    opt.value=String(idx);
    opt.textContent=w.name;
    ammoWeaponSelect.appendChild(opt);
  });
}

/* =========================
   Attachments renderers
========================= */
function renderAttachmentsLegacyList(w){
  attachmentsList.innerHTML="";
  (w.attachments||[]).forEach((a,idx)=>{
    // nu afișăm țeavă în listă (component)
    if(slotOfAttachmentName(a.name)==="Component") return;
    const div=document.createElement("div");
    div.className="attach";
    div.innerHTML = `<label><input type="checkbox" class="attCheck" value="${idx}"> ${a.name}</label>`;
    attachmentsList.appendChild(div);
  });
}

function renderAttachmentsSlots(w){
  slotModeWrap.innerHTML="";
  const att = (w.attachments||[]).map((a,idx)=>({idx, ...a})).filter(x=>slotOfAttachmentName(x.name)!=="Component");
  if(att.length===0) return false;

  // group by slot
  const groups = {};
  att.forEach(a=>{
    const slot = slotOfAttachmentName(a.name);
    groups[slot] = groups[slot] || [];
    groups[slot].push(a);
  });

  // stable slot order
  const slotOrder = ["Magazin","Amortizor","Optică","Grip","Muzzle","Lanternă","Altele"];
  const keys = Object.keys(groups).sort((a,b)=>{
    const ia = slotOrder.indexOf(a); const ib = slotOrder.indexOf(b);
    return (ia===-1?999:ia) - (ib===-1?999:ib);
  });

  keys.forEach(slot=>{
    const card=document.createElement("div");
    card.className="slotCard";
    card.innerHTML = `
      <div class="slotHeader">
        <div class="slotTitle">${slot}</div>
        <div class="slotChips"><span class="tag">1 slot</span></div>
      </div>
      <div class="row" style="gap:8px; flex-wrap:wrap;" data-slot="${slot}"></div>
    `;
    const row = card.querySelector("[data-slot]");
    // none option

    groups[slot].forEach(a=>{
      row.appendChild(makeSlotOption(slot, a.name, a.idx, false));
    });
    slotModeWrap.appendChild(card);
  });

  // default: none everywhere
  slotModeWrap.querySelectorAll(".slotOpt[data-active-default='1']").forEach(el=>el.classList.add("active"));
  return true;
}

function makeSlotOption(slot, label, attIdx, isDefault){
  const div=document.createElement("div");
  div.className="slotOpt";
  if(isDefault) div.setAttribute("data-active-default","1");
  div.setAttribute("data-slot", slot);
  div.setAttribute("data-att-idx", attIdx===null ? "" : String(attIdx));
  div.innerHTML = `
    <img class="miniIcon" src="${materialIcons.polymer}" alt="">
    <b style="font-size:12px;">${label}</b>
  `;
  div.addEventListener("click", ()=>{
    // single select within slot
    const all=[...slotModeWrap.querySelectorAll(`.slotOpt[data-slot="${cssEscape(slot)}"]`)];
    // all.forEach(x=>x.classList.remove("active"));
    console.log(div.classList.contains("active"));
    if (!div.classList.contains("active")) {
        div.classList.add("active");
    } else {
        div.classList.remove("active");
    }
    updateLivePreview();
  });
  return div;
}

function cssEscape(s){
  return (s||"").replace(/"/g,'\"');
}

function getSelectedAttachmentsFromSlots(w){
  const attIndexes=[];
  const cards=[...slotModeWrap.querySelectorAll(".slotCard")];
  cards.forEach(card=>{
    const slot=card.querySelector("[data-slot]")?.getAttribute("data-slot") || "";
    const active = card.querySelector(`.slotOpt.active[data-slot="${cssEscape(slot)}"]`);
    if(!active) return;
    const idxStr = active.getAttribute("data-att-idx");
    if(idxStr!==null && idxStr!==""){
      const idx=Number(idxStr);
      if(Number.isFinite(idx)) attIndexes.push(idx);
    }
  });
  return attIndexes;
}

/* =========================
   Attachments controls
========================= */
function syncAttachmentsUI(){
  const w=getSelectedWeapon();
  if(!w) return;

  const hasAtt = (w.attachments||[]).filter(a=>slotOfAttachmentName(a.name)!=="Component").length>0;

  if(!hasAtt){
    hide(attachmentsStep);
    updateLivePreview();
    return;
  }

  show(attachmentsStep);

  // toggle modes
  if(slotModeToggle.checked){
    slotModeWrap.style.display="";
    attachmentsList.style.display="none";
  }else{
    slotModeWrap.style.display="none";
    attachmentsList.style.display="";
  }

  if(noAttach.checked){
    attachmentsHint.textContent="Atașamentele NU sunt luate în calcul.";
    slotModeWrap.style.opacity=".45";
    attachmentsList.style.opacity=".45";
    slotModeWrap.style.pointerEvents="none";
    attachmentsList.style.pointerEvents="none";
  }else{
    attachmentsHint.textContent="";
    slotModeWrap.style.opacity="";
    attachmentsList.style.opacity="";
    slotModeWrap.style.pointerEvents="";
    attachmentsList.style.pointerEvents="";
  }

  updateLivePreview();
}

noAttach.addEventListener("change", syncAttachmentsUI);
slotModeToggle.addEventListener("change", syncAttachmentsUI);
attachmentsList.addEventListener("change", (e)=>{
  if(e.target && e.target.classList.contains("attCheck")) updateLivePreview();
});
qtyInput.addEventListener("input", ()=>{
  if(parseInt(qtyInput.value||"1",10) < 1) qtyInput.value = "1";
  updateLivePreview();
});

/* =========================
   FLOW
========================= */
function updateSelectedWeaponCard(w){
  if(!w){
    selectedWeaponLabel.textContent="-- Selectează arma --";
    selectedWeaponImg.src = imageForWeapon("PISTOL");
    selectedWeaponImg.alt = "";
    return;
  }
  selectedWeaponLabel.textContent = w.name;
  selectedWeaponImg.src = imageForWeapon(w.name);
  selectedWeaponImg.alt = w.name;
}

function getSelectedWeapon(){
  const idx = weaponSelect.value;
  if(idx==="") return null;
  return weapons[Number(idx)];
}

function handleWeaponChange(){
  resultDiv.style.display="none";
  const w=getSelectedWeapon();
  if(!w){ resetFlow(); updateSelectedWeaponCard(null); return; }

  updateSelectedWeaponCard(w);

  hide(bulletsStep); hide(attachmentsStep); hide(qtyStep);
  slotModeWrap.innerHTML="";
  attachmentsList.innerHTML="";
  bulletsSelect.innerHTML="";
  noAttach.checked=false;
  ammoHint.textContent="";
  attachmentsHint.textContent="";

  fillBullets(bulletsSelect);
  show(bulletsStep);

  // default 100 + trigger (fix: can calculate without extra change)
  bulletsSelect.value="100";
  handleBulletsChange();
}

function handleBulletsChange(){
  const w=getSelectedWeapon();
  if(!w) return;

  const b = parseInt(bulletsSelect.value || "100", 10);
  const am = ammoExactInterpolated(w.name, b);
  ammoHint.textContent = `Praf: ${Math.round(am.powder)} • Cost: ${money(am.price)}`;

  // attachments build
  renderAttachmentsLegacyList(w);
  renderAttachmentsSlots(w);
  show(qtyStep);
  syncAttachmentsUI();

  updateLivePreview();
}

weaponSelect.addEventListener("change", handleWeaponChange);
bulletsSelect.addEventListener("change", handleBulletsChange);

// zoom from selected button
selectedWeaponImg.addEventListener("click", ()=>{
  const w=getSelectedWeapon();
  if(!w) return;
  openLightbox(w.name, imageForWeapon(w.name));
});

/* =========================
   CALC click
========================= */
calcBtn.addEventListener("click", ()=>{
  const sel=currentSelectionToObject();
  if(!sel){ 
        Swal.fire({
            title: 'Eroare!',
            text: 'Selectează o armă!',
            icon: 'error',
            confirmButtonText: 'OK',
            background: '#1e1e1e',
            color: '#ffffff',
            confirmButtonColor: 'var(--green)'
        })
    return; 
  }
  const out=computeOneSelection(sel);
  renderResult(out, false);
  resultDiv.scrollIntoView({behavior:"smooth", block:"start"});
});

/* =========================
   CART
========================= */
const CART_KEY="fivem_cart_v5";
let cart=[];
function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }
function loadCart(){
  try{
    const raw=localStorage.getItem(CART_KEY);
    cart = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(cart)) cart=[];
  }catch(e){ cart=[]; }
}
function renderCart(){
  cartList.innerHTML="";
  cartResult.style.display="none";
  if(cart.length===0){
    cartList.innerHTML=`<div class="muted">—</div>`;
    return;
  }
  cart.forEach((it,idx)=>{
    const w=weapons[it.weaponIndex];
    const chips=[];
    chips.push(`<span class="mini">${w.type==="craft"?"Craft":"OFICIALA"}</span>`);
    chips.push(`<span class="mini">${it.qty} arme</span>`);
    chips.push(`<span class="mini">${it.bullets} gl</span>`);
    chips.push(`<span class="mini">${it.noAttach ? "fără ataș." : (it.selectedAtt?.length||0)+" ataș."}</span>`);

    const div=document.createElement("div");
    div.className="cartItem";
    div.innerHTML=`
      <div class="cartTitle">
        <div class="row" style="gap:10px; align-items:center;">
          <img src="${imageForWeapon(w.name)}" alt="${w.name}"
               style="width:54px;height:54px;border-radius:16px;object-fit:contain;border:1px solid var(--border);background:#0f0f0f;cursor:zoom-in;"
               data-zoom-name="${w.name}">
          <div>
            <b>${w.name}</b>
            <div class="muted">${categoryOf(w.name)} • ${w.type==="craft"?"Craft":"OFICIALA"}</div>
          </div>
        </div>
        <div class="cartMeta">${chips.join("")}</div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="btn secondary" data-act="dup" data-idx="${idx}" type="button">Duplică</button>
        <button class="btn danger" data-act="del" data-idx="${idx}" type="button">Șterge</button>
      </div>
    `;
    cartList.appendChild(div);
  });

  cartList.querySelectorAll("img[data-zoom-name]").forEach(img=>{
    img.addEventListener("click", ()=>{
      const name=img.getAttribute("data-zoom-name");
      openLightbox(name, imageForWeapon(name));
    });
  });

  cartList.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const idx=Number(btn.getAttribute("data-idx"));
      const act=btn.getAttribute("data-act");
      if(act==="del"){
        cart.splice(idx,1);
        saveCart(); renderCart();
      }else if(act==="dup"){
        cart.splice(idx+1,0, JSON.parse(JSON.stringify(cart[idx])));
        saveCart(); renderCart();
      }
    });
  });
}
addToCartBtn.addEventListener("click", ()=>{
  const sel=currentSelectionToObject();
  if(!sel){ 
        Swal.fire({
            title: 'Eroare!',
            text: 'Selectează o armă!',
            icon: 'error',
            confirmButtonText: 'OK',
            background: '#1e1e1e',
            color: '#ffffff',
            confirmButtonColor: 'var(--green)'
        })
    return; }
  cart.push(sel);
  saveCart();
  renderCart();
});
clearCartBtn.addEventListener("click", ()=>{
  cart=[];
  saveCart();
  renderCart();
});
calcCartBtn.addEventListener("click", ()=>{
  if(cart.length===0){ 
        Swal.fire({
            title: 'Eroare!',
            text: 'Coșul e gol.',
            icon: 'error',
            confirmButtonText: 'OK',
            background: '#1e1e1e',
            color: '#ffffff',
            confirmButtonColor: 'var(--green)'
        })
    return; }

  const totalTotals=emptyTotals();
  let sumWeapon=0, sumAmmo=0, sumMats=0, sumAll=0;

  cart.forEach(sel=>{
    const out=computeOneSelection(sel);
    sumInto(totalTotals, out.grandTotals, 1);
    sumWeapon += out.costWeapon;
    sumAmmo += out.costAmmo;
    sumMats += out.costMats;
    sumAll += out.total;
  });

  const cards = materialOrder.map(k=>matCardHTML(k, totalTotals[k])).join("");
  const grid = cards ? `<div class="matGrid">${cards}</div>` : `<div class="muted">—</div>`;

  cartResult.style.display="block";
  cartResult.innerHTML=`
    <h3>Total Coș</h3>
    <div class="grid">
      <div class="box">
        <div class="muted">Total</div>
        <div style="font-size:22px;font-weight:900;">${money(sumAll)}</div>
        <hr>
        <div><b>Cost arme:</b> ${money(sumWeapon)}</div>
        <div><b>Gloanțe:</b> ${money(sumAmmo)}</div>
        <div><b>Materiale:</b> ${money(sumMats)}</div>
      </div>
      <div class="box">
        <h3 style="margin-top:0;">Materiale (Total)</h3>
        ${grid}
      </div>
    </div>
  `;
  cartResult.scrollIntoView({behavior:"smooth", block:"start"});
});

/* =========================
   MODAL + SEARCH
========================= */
let modalCategory = "ALL";

function openModal(){
  weaponModal.classList.add("show");
  modalSearch.value = "";
  modalCategory = "ALL";
  pills.forEach(p=>p.classList.toggle("active", p.dataset.cat==="ALL"));
  renderWeaponGrid();
  setTimeout(()=> modalSearch.focus(), 20);
}
function closeModal(){
  weaponModal.classList.remove("show");
  hideTooltip();
}

openWeaponModalBtn.addEventListener("click", openModal);
closeWeaponModalBtn.addEventListener("click", closeModal);
weaponModal.addEventListener("click", (e)=>{ if(e.target === weaponModal) closeModal(); });
window.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && weaponModal.classList.contains("show")) closeModal(); });

pills.forEach(p=>{
  p.addEventListener("click", ()=>{
    modalCategory = p.dataset.cat;
    pills.forEach(x=>x.classList.toggle("active", x===p));
    renderWeaponGrid();
  });
});
modalSearch.addEventListener("input", renderWeaponGrid);

/* Tooltip + Lightbox */
function showTooltipAt(x,y){
  tooltip.classList.add("show");
  const pad = 14;
  const w = tooltip.offsetWidth;
  const h = tooltip.offsetHeight;
  let left = x + pad;
  let top  = y + pad;
  if(left + w > window.innerWidth - 10) left = x - w - pad;
  if(top + h > window.innerHeight - 10) top = y - h - pad;
  tooltip.style.left = left + "px";
  tooltip.style.top  = top  + "px";
}
function hideTooltip(){ tooltip.classList.remove("show"); }

function tooltipForWeapon(w){
  const idx = weapons.findIndex(x=>x.name===w.name);
  const sel = {weaponIndex: idx, qty:1, bullets:100, noAttach:true, selectedAtt:[]};
  const out = computeOneSelection(sel);
  const am = ammoExactInterpolated(w.name, 100);

  tipTitle.textContent = w.name;
  tipType.textContent = (w.type==="craft" ? "Craft" : "OFICIALA");
  tipCost.textContent = money(out.total);
  tipPowder.textContent = Math.round(am.powder);

  const mats = [];
  if(w.type==="craft"){
    mats.push(`Oțel ${w.materials?.steel||0}, Șuruburi ${w.materials?.screw||0}, Țeavă ${w.materials?.barrel||0}, Polimer ${w.materials?.polymer||0}`);
  }else{
    mats.push(`Preț armă: ${money(w.price||0)}`);
  }
  mats.push(`Gloanțe (100): ${money(am.price)}`);
  tipMats.textContent = mats.join(" • ");
}

function openLightbox(name, imgUrl){
  lbTitle.textContent = name;
  lbImg.src = imgUrl;
  lbImg.alt = name;
  lightbox.classList.add("show");
}
function closeLightbox(){ lightbox.classList.remove("show"); }
lbClose.addEventListener("click", closeLightbox);
lightbox.addEventListener("click", (e)=>{ if(e.target === lightbox) closeLightbox(); });
window.addEventListener("keydown",(e)=>{ if(e.key==="Escape" && lightbox.classList.contains("show")) closeLightbox(); });

/* Weapon grid */
function renderWeaponGrid(){
  const q = (modalSearch.value||"").trim().toLowerCase();
  weaponGrid.innerHTML = "";
  let count = 0;

  weapons.forEach((w, idx)=>{
    const cat = categoryOf(w.name);
    const typeLabel = (w.type==="craft" ? "Craft" : "OFICIALA");

    if(modalCategory !== "ALL"){
      if(modalCategory === "OFICIALA" && w.type!=="money") return;
      if(modalCategory !== "OFICIALA" && modalCategory !== cat) return;
    }

    const hay = (w.name + " " + cat + " " + typeLabel).toLowerCase();
    if(q && !hay.includes(q)) return;

    count++;

    const card=document.createElement("div");
    card.className="wCard";

    const img=imageForWeapon(w.name);

    card.innerHTML=`
      <img class="wImg" src="${img}" alt="${w.name}" loading="lazy">
      <div class="wInfo">
        <div class="wName">${w.name}</div>
        <div class="wMetaRow">
          <span class="tag">${cat}</span>
          <span class="tag">${typeLabel}</span>
          <button class="selBtn" type="button" data-sel="${idx}">Selectează</button>
        </div>
      </div>
    `;

    // click pe imagine => zoom
    card.querySelector(".wImg").addEventListener("click", (e)=>{
      e.stopPropagation();
      openLightbox(w.name, img);
    });

    // select button
    card.querySelector("button[data-sel]").addEventListener("click", (e)=>{
      e.stopPropagation();
      weaponSelect.value = String(idx);
      weaponSelect.dispatchEvent(new Event("change"));
      closeModal();
    });

    // hover tooltip
    card.addEventListener("mouseenter", (ev)=>{ tooltipForWeapon(w); showTooltipAt(ev.clientX, ev.clientY); });
    card.addEventListener("mousemove", (ev)=>{ if(tooltip.classList.contains("show")) showTooltipAt(ev.clientX, ev.clientY); });
    card.addEventListener("mouseleave", hideTooltip);

    weaponGrid.appendChild(card);
  });

  weaponGridEmpty.style.display = count===0 ? "block" : "none";
}

/* =========================
   Page: Ammo only
========================= */
function renderAmmoOnly(){
  const idx = Number(ammoWeaponSelect.value||"0");
  const w = weapons[idx];
  const bullets = parseInt(ammoOnlyBullets.value||"100",10);
  const am = ammoExactInterpolated(w.name, bullets);

  ammoOnlyImg.src = imageForWeapon(w.name);
  ammoOnlyImg.alt = w.name;
  ammoOnlyName.textContent = w.name;
  ammoOnlyMeta.textContent = `${categoryOf(w.name)} • ${w.type==="craft" ? "Craft" : "OFICIALA"} • ${bullets} gl`;

  // show only powder card
  ammoOnlyMats.innerHTML = `<div class="matGrid">${matCardHTML("powder", am.powder)}</div>`;
  ammoOnlyCost.textContent = money(am.price);
  ammoOnlyPowder.textContent = `${Math.round(am.powder)} praf`;
}

ammoWeaponSelect.addEventListener("change", renderAmmoOnly);
ammoOnlyBullets.addEventListener("change", renderAmmoOnly);
ammoOnlyImg.addEventListener("click", ()=> openLightbox(ammoOnlyName.textContent, ammoOnlyImg.src));

/* =========================
   Tabs switch
========================= */
function setActivePage(pageId){
  Object.keys(pages).forEach(id=> pages[id].classList.toggle("show", id===pageId));
  tabs.forEach(t=> t.classList.toggle("active", t.dataset.page===pageId));
  // fade
  pages[pageId].classList.add("fadeIn");
  setTimeout(()=> pages[pageId].classList.remove("fadeIn"), 260);
}
tabs.forEach(t=>{
  t.addEventListener("click", ()=> setActivePage(t.dataset.page));
});

/* =========================
   Share link (no presets saved, just URL params)
========================= */
function buildShareURL(){
  const sel = currentSelectionToObject();
  const url = new URL(window.location.href);
  if(sel){
    url.searchParams.set("w", String(sel.weaponIndex));
    url.searchParams.set("b", String(sel.bullets));
    url.searchParams.set("q", String(sel.qty));
    url.searchParams.set("na", sel.noAttach ? "1":"0");
    url.searchParams.set("sm", slotModeToggle.checked ? "1":"0");
    url.searchParams.set("a", (sel.selectedAtt||[]).join(","));
  }
  return url.toString();
}
copyLinkBtn.addEventListener("click", ()=>{
  const u = buildShareURL();
  navigator.clipboard?.writeText(u);
});

/* Apply URL params */
function applyFromURL(){
  const url = new URL(window.location.href);
  const w = url.searchParams.get("w");
  const b = url.searchParams.get("b");
  const q = url.searchParams.get("q");
  const na = url.searchParams.get("na");
  const sm = url.searchParams.get("sm");
  const a = url.searchParams.get("a");

  if(sm!==null) slotModeToggle.checked = (sm==="1");
  if(w!==null && w!=="" && !isNaN(Number(w))){
    weaponSelect.value = String(Number(w));
    weaponSelect.dispatchEvent(new Event("change"));
    if(b!==null && b!=="" && !isNaN(Number(b))){
      bulletsSelect.value = String(Number(b));
      bulletsSelect.dispatchEvent(new Event("change"));
    }
    if(q!==null && q!=="" && !isNaN(Number(q))){
      qtyInput.value = String(Math.max(1, Number(q)));
    }
    if(na!==null) noAttach.checked = (na==="1");

    // apply attachments after render
    setTimeout(()=>{
      const wObj=getSelectedWeapon();
      if(!wObj) return;

      if(slotModeToggle.checked){
        // set active based on indices
        const wanted = new Set((a||"").split(",").filter(x=>x!=="" ).map(x=>Number(x)));
        // clear actives -> default within each slot
        slotModeWrap.querySelectorAll(".slotCard").forEach(card=>{
          const opts=[...card.querySelectorAll(".slotOpt")];
          opts.forEach(o=>o.classList.remove("active"));
          const none = opts.find(o=> (o.getAttribute("data-att-idx")||"")==="");
          if(none) none.classList.add("active");
          // activate one matching if present
          const match = opts.find(o=>{
            const v=o.getAttribute("data-att-idx");
            return v!==null && v!=="" && wanted.has(Number(v));
          });
          if(match){
            opts.forEach(o=>o.classList.remove("active"));
            match.classList.add("active");
          }
        });
      }else{
        const wanted = new Set((a||"").split(",").filter(x=>x!=="" ).map(x=>Number(x)));
        attachmentsList.querySelectorAll(".attCheck").forEach(cb=>{
          cb.checked = wanted.has(Number(cb.value));
        });
      }
      syncAttachmentsUI();
      updateLivePreview();
    }, 20);
  }
}

/* =========================
   INIT
========================= */
function init(){
  buildWeaponSelect();
  resetFlow();
  updateSelectedWeaponCard(null);
  selectedWeaponImg.src = imageForWeapon("PISTOL");

  // bullets selects
  fillBullets(ammoOnlyBullets);

  // cart
  loadCart();
  renderCart();

  // ammo page initial
  ammoWeaponSelect.value = "0";
  ammoOnlyBullets.value = "100";
  renderAmmoOnly();

  applyFromURL();
}
init();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>FiveM Craft Calculator</title>
<style>
  :root{
    /* ✅ Schimbă aici imaginea de fundal */
    --bg-url: url("https://i.imgur.com/hdGnzUT.jpeg");
  }

  body{
    margin:0;
    font-family: Arial, sans-serif;
    color:#fff;
    min-height:100vh;
    display:flex;
    justify-content:center;
    padding:20px;
    background:#0d0d0d;
    position:relative;
    overflow-x:hidden;
  }
  body::before{
    content:"";
    position:fixed;
    inset:0;
    background-image: var(--bg-url);
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
    filter: blur(2px);
    transform: scale(1.03);
    z-index:-2;
  }
  body::after{
    content:"";
    position:fixed;
    inset:0;
    background: radial-gradient(circle at 30% 0%, rgba(0,0,0,.25), rgba(0,0,0,.85) 60%, rgba(0,0,0,.92));
    z-index:-1;
  }

  .container{
    width:1000px;
    max-width:100%;
    background: rgba(0,0,0,0.85);
    border:1px solid rgba(255,255,255,0.06);
    border-radius:14px;
    padding:24px;
    backdrop-filter: blur(6px);
  }

  h3{margin:10px 0 10px;}
  .box{
    background: rgba(16,16,16,0.85);
    border:1px solid rgba(255,255,255,0.06);
    border-radius:14px;
    padding:14px;
  }

  .field{
    display:flex;
    align-items:center;
    gap:12px;
    margin:10px 0;
    flex-wrap:wrap;
  }
  .field label{
    width:220px;
    max-width:100%;
    opacity:.9;
  }
  .field select,.field input{
    flex:1;
    min-width:240px;
    padding:10px;
    font-size:14px;
    border-radius:10px;
    border:1px solid #444;
    background:#1c1c1c;
    color:#fff;
    transition:.2s;
  }
  .field select:focus,.field input:focus{
    outline:none;
    border-color:#2ecc71;
  }

  .row{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }

  .btn{
    cursor:pointer;
    border:none;
    border-radius:10px;
    padding:10px 12px;
    font-weight:800;
    color:#fff;
    background:#2ecc71;
    transition:.2s;
  }
  .btn:hover{background:#27ae60;}
  .btn.secondary{
    background:#141414;
    border:1px solid #2a2a2a;
    font-weight:700;
  }
  .btn.secondary:hover{background:#1b1b1b;}
  .btn.danger{background:#c0392b;}
  .btn.danger:hover{background:#a93226;}

  .step{
    overflow:hidden;
    max-height:0;
    opacity:0;
    transform: translateY(-6px);
    transition:max-height .35s ease, opacity .25s ease, transform .25s ease;
    border-left:3px solid transparent;
    padding-left:0;
    margin-top:0;
  }
  .step.show{
    max-height:1200px;
    opacity:1;
    transform: translateY(0);
    border-left-color:#2ecc71;
    padding-left:12px;
    margin-top:12px;
  }

  .attachments{margin-top:8px;}
  .attach{margin:8px 0;}
  .attach label{cursor:pointer;}
  .attach input{transform: translateY(1px); accent-color:#2ecc71;}

  .result{
    margin-top:14px;
    padding:14px;
    border-radius:14px;
    background:#141414;
    border:1px solid #2a2a2a;
    display:none;
  }

  .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }
  @media (max-width: 900px){
    .grid{grid-template-columns:1fr;}
    .field select,.field input{min-width:0; width:100%;}
    .field label{width:100%;}
  }

  hr{border:0; border-top:1px solid #2a2a2a; margin:12px 0;}

  /* Search results */
  .searchResults{
    margin-top:10px;
    border:1px solid #2a2a2a;
    border-radius:14px;
    background:#101010;
    max-height:220px;
    overflow:auto;
  }
  .srItem{
    padding:10px 12px;
    border-top:1px solid #1f1f1f;
    cursor:pointer;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
  }
  .srItem:first-child{border-top:none;}
  .srItem:hover{background:#181818;}
  .srLeft{display:flex; flex-direction:column; gap:2px;}
  mark{
    background:#2ecc71;
    color:#08130b;
    padding:0 2px;
    border-radius:4px;
  }

  /* Cart */
  .cartList{margin-top:10px; display:flex; flex-direction:column; gap:10px;}
  .cartItem{
    border:1px solid #2a2a2a;
    background:#101010;
    border-radius:14px;
    padding:12px;
  }
  .cartTitle{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
  .cartMeta{display:flex; gap:8px; flex-wrap:wrap;}
  .mini{font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid #2a2a2a; background:#161616;}
</style>
</head>
<body>

<div class="container">

  <!-- STEP 1 -->
  <div class="box">
    <h3 style="margin-top:0;">Ce vrei să craftezi?</h3>

    <div class="field">
      <label for="weaponSearch">Caută armă:</label>
      <input id="weaponSearch" type="text" placeholder="ex: pistol, smg, rifle..." />
    </div>

    <div class="searchResults" id="searchResults"></div>

    <div class="field">
      <label for="weaponSelect">Arma (listă):</label>
      <select id="weaponSelect">
        <option value="">-- Selectează arma --</option>
      </select>
    </div>
  </div>

  <!-- STEP 2 -->
  <div class="step" id="bulletsStep">
    <div class="box">
      <h3 style="margin-top:0;">Gloanțe</h3>
      <div class="field">
        <label for="bulletsSelect">Cantitate:</label>
        <select id="bulletsSelect"></select>
      </div>
      <div class="muted" id="ammoHint"></div>
    </div>
  </div>

  <!-- STEP 3 -->
  <div class="step" id="attachmentsStep">
    <div class="box">
      <div class="row" style="justify-content:space-between;">
        <h3 style="margin:0;">Atașamente</h3>
        <label style="opacity:.85;">
          <input type="checkbox" id="noAttach" />
          Nu vreau atașamente
        </label>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn secondary" id="fullKitBtn">Full kit</button>
        <button class="btn secondary" id="noKitBtn">No attachments</button>
      </div>

      <div class="attachments" id="attachmentsList"></div>
      <div style="opacity:.75;" id="attachmentsHint"></div>
    </div>
  </div>

  <!-- STEP 4 -->
  <div class="step" id="qtyStep">
    <div class="box">
      <h3 style="margin-top:0;">Cantitate & Calcul</h3>
      <div class="field">
        <label for="qty">Număr arme:</label>
        <input type="number" id="qty" min="1" value="1"/>
      </div>

      <div class="row">
        <button class="btn" id="calcBtn">Calculează</button>
        <button class="btn secondary" id="addToCartBtn">Adaugă în coș</button>
      </div>
    </div>
  </div>

  <div id="result" class="result"></div>

  <!-- CART -->
  <div class="box" style="margin-top:14px;">
    <div class="row" style="justify-content:space-between;">
      <h3 style="margin:0;">Coș</h3>
      <div class="row">
        <button class="btn secondary" id="calcCartBtn">Calculează coș</button>
        <button class="btn danger" id="clearCartBtn">Golește coș</button>
      </div>
    </div>
    <div style="opacity:.75;">Total cumulat materiale + cost.</div>
    <div id="cartList" class="cartList"></div>
    <div id="cartResult" class="result" style="display:none;"></div>
  </div>

</div>

<script>
/* =========================
   CONFIG COSTURI
========================= */
const COST_STEEL = 5000;
const COST_POLYMER = 150;
// șuruburi: 20 = 1 oțel
function costFromScrews(totalScrews){ return Math.floor((totalScrews||0)/20) * COST_STEEL; }

/* =========================
   BULLETS OPTIONS 100..2000
========================= */
const BULLET_OPTIONS = [];
for(let b=100;b<=2000;b+=100) BULLET_OPTIONS.push(b);

/* =========================
   AMMO TABLE - EXACT 100/200/250 + interpolare
   (textul “EXACT în tabel...” e scos din UI, dar logica rămâne)
========================= */
const ammoTable = {
  "PISTOL":                   [{b:100,powder:100,price:5400},{b:200,powder:200,price:10666},{b:250,powder:250,price:13333}],
  "COMBAT PISTOL":            [{b:100,powder:100,price:5400},{b:200,powder:200,price:10700},{b:250,powder:250,price:13400}],
  "PISTOL MK2":               [{b:100,powder:130,price:7000},{b:200,powder:260,price:13900},{b:250,powder:325,price:17400}],
  "CERAMIC PISTOL":           [{b:100,powder:130,price:7000},{b:200,powder:260,price:13900},{b:250,powder:325,price:17400}],
  "PISTOL WM29 (XM3)":        [{b:100,powder:130,price:7000},{b:200,powder:260,price:13900},{b:250,powder:325,price:17400}],

  "MICRO SMG":                [{b:100,powder:150,price:8000},{b:200,powder:300,price:16000},{b:250,powder:375,price:20000}],
  "MACHINE PISTOL (Tec9)":    [{b:100,powder:150,price:8000},{b:200,powder:300,price:16000},{b:250,powder:375,price:20000}],
  "MINI SMG":                 [{b:100,powder:150,price:8000},{b:200,powder:300,price:16000},{b:250,powder:375,price:20000}],

  "TEC PISTOL (Tactical SMG)":[{b:100,powder:180,price:10000},{b:200,powder:360,price:19000},{b:250,powder:450,price:24000}],
  "SMG":                      [{b:100,powder:180,price:10000},{b:200,powder:360,price:19000},{b:250,powder:450,price:24000}],
  "COMBAT PDW":               [{b:100,powder:180,price:10000},{b:200,powder:360,price:19000},{b:250,powder:450,price:24000}],

  "ASSAULT RIFLE (AK)":       [{b:100,powder:250,price:13400},{b:200,powder:500,price:26700},{b:250,powder:625,price:33400}],
  "COMPACT RIFLE":            [{b:100,powder:250,price:13400},{b:200,powder:500,price:26700},{b:250,powder:625,price:33400}],
  "CARABINE RIFLE":           [{b:100,powder:300,price:16000},{b:200,powder:600,price:32000},{b:250,powder:750,price:40000}],
  "ADVANCED RIFLE":           [{b:100,powder:300,price:16000},{b:200,powder:600,price:32000},{b:250,powder:750,price:40000}],

  "Navy Pistol":              [{b:100,powder:500,price:26700},{b:200,powder:1000,price:54000},{b:250,powder:1250,price:66700}],
  "VINTIGE PISTOL":           [{b:100,powder:150,price:8000},{b:200,powder:300,price:16000},{b:250,powder:375,price:20000}],
  "DB":                       [{b:100,powder:500,price:26700},{b:200,powder:1000,price:54000},{b:250,powder:1250,price:66700}],
  "ASSAULTRIFE MK2 (AK)":     [{b:100,powder:300,price:16000},{b:200,powder:600,price:32000},{b:250,powder:750,price:40000}],
  "HEAVYRIFLE":               [{b:100,powder:300,price:16000},{b:200,powder:600,price:32000},{b:250,powder:750,price:40000}],
  "COMBAT MG":                [{b:100,powder:300,price:16000},{b:200,powder:600,price:32000},{b:250,powder:750,price:40000}],
  "GUSENBERG":                [{b:100,powder:180,price:9600},{b:200,powder:360,price:19000},{b:250,powder:450,price:24000}],
  "MG":                       [{b:100,powder:300,price:16000},{b:200,powder:600,price:32000},{b:250,powder:750,price:40000}],
};

function lerp(a,b,t){ return a + (b-a)*t; }
function ammoExactInterpolated(weaponName, bullets){
  const pts = ammoTable[weaponName];
  if(!pts) return {powder:0, price:0};
  const p100=pts[0], p200=pts[1], p250=pts[2];

  if(bullets===100) return {powder:p100.powder, price:p100.price};
  if(bullets===200) return {powder:p200.powder, price:p200.price};
  if(bullets===250) return {powder:p250.powder, price:p250.price};

  if(bullets <= 200){
    const t=(bullets-100)/(200-100);
    return {powder:lerp(p100.powder,p200.powder,t), price:lerp(p100.price,p200.price,t)};
  }
  if(bullets <= 250){
    const t=(bullets-200)/(250-200);
    return {powder:lerp(p200.powder,p250.powder,t), price:lerp(p200.price,p250.price,t)};
  }
  const slopePowder = (p250.powder - p200.powder) / (250-200);
  const slopePrice  = (p250.price  - p200.price ) / (250-200);
  const extra = bullets - 250;
  return {powder: p250.powder + slopePowder*extra, price: p250.price + slopePrice*extra};
}

/* =========================
   WEAPONS + ATTACHMENTS
========================= */
function att(name, data){ return { name, data }; }
function emptyTotals(){ return {steel:0,screw:0,barrel:0,spring:0,wood:0,polymer:0,bec:0,lupa:0,powder:0}; }
function sumInto(dst, src, mult=1){
  Object.keys(src||{}).forEach(k=>{
    dst[k] = (dst[k]||0) + (src[k]||0) * mult;
  });
}

const weapons = [
  // CRAFT (ordinea ta)
  { name:"PISTOL", type:"craft", materials:{steel:8,screw:80,barrel:0,spring:1,wood:0,polymer:20},
    attachments:[ att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}), att("Amortizor",{steel:2,screw:5,polymer:2}), att("Încărcător",{steel:1,screw:5,spring:1,polymer:1}) ] },
  { name:"COMBAT PISTOL", type:"craft", materials:{steel:8,screw:85,barrel:0,spring:0,wood:0,polymer:18},
    attachments:[ att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}), att("Amortizor",{steel:2,screw:5,polymer:2}), att("Încărcător",{steel:1,screw:5,spring:1,polymer:1}) ] },
  { name:"PISTOL MK2", type:"craft", materials:{steel:9,screw:91,barrel:0,spring:1,wood:0,polymer:22},
    attachments:[ att("Încărcător",{steel:1,screw:5,spring:1,polymer:1}), att("Mounted-Scope",{steel:2,screw:10,polymer:2,lupa:1}), att("Amortizor",{steel:2,screw:5,polymer:2}), att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}) ] },
  { name:"CERAMIC PISTOL", type:"craft", materials:{steel:9,screw:91,barrel:0,spring:1,wood:0,polymer:18},
    attachments:[ att("Amortizor",{steel:2,screw:5,polymer:2}), att("Încărcător",{steel:1,screw:5,spring:1,polymer:1}) ] },
  { name:"PISTOL WM29 (XM3)", type:"craft", materials:{steel:10,screw:95,barrel:0,spring:1,wood:0,polymer:20},
    attachments:[ att("Amortizor",{steel:2,screw:5,polymer:2}) ] },

  { name:"MICRO SMG", type:"craft", materials:{steel:15,screw:95,barrel:1,spring:1,wood:0,polymer:42},
    attachments:[ att("Lunetă",{steel:2,screw:10,polymer:2,lupa:1}), att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}), att("Amortizor",{steel:3,screw:5,polymer:3}), att("Încărcător",{steel:2,screw:10,spring:1,polymer:2}) ] },
  { name:"MACHINE PISTOL (Tec9)", type:"craft", materials:{steel:12,screw:100,barrel:0,spring:1,wood:0,polymer:38},
    attachments:[ att("Amortizor",{steel:2,screw:5,polymer:2}), att("Încărcător",{steel:2,screw:8,spring:1,polymer:2}) ] },
  { name:"MINI SMG", type:"craft", materials:{steel:11,screw:97,barrel:0,spring:1,wood:1,polymer:36},
    attachments:[ att("Încărcător",{steel:2,screw:10,spring:1,polymer:2}) ] },
  { name:"TEC PISTOL (Tactical SMG)", type:"craft", materials:{steel:14,screw:115,barrel:1,spring:1,wood:0,polymer:44},
    attachments:[ att("Lunetă",{steel:2,screw:10,polymer:2,lupa:1}), att("Încărcător",{steel:2,screw:10,spring:1,polymer:2}), att("Suppresor-Muzzle-Brake",{steel:3,screw:5,polymer:3}) ] },
  { name:"SMG", type:"craft", materials:{steel:13,screw:105,barrel:1,spring:1,wood:0,polymer:48},
    attachments:[ att("Încărcător",{steel:2,screw:10,spring:1,polymer:2}), att("Baterie-Gloante",{steel:3,screw:20,spring:1,polymer:3}), att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}), att("Amortizor",{steel:3,screw:5,polymer:3}), att("Lunetă",{steel:2,screw:10,polymer:2,lupa:1}) ] },
  { name:"COMBAT PDW", type:"craft", materials:{steel:14,screw:110,barrel:1,spring:1,wood:0,polymer:50},
    attachments:[ att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}), att("Baterie-Gloante",{steel:3,screw:20,spring:1,polymer:3}), att("Lunetă",{steel:2,screw:10,polymer:2,lupa:1}), att("Încărcător",{steel:2,screw:10,spring:1,polymer:2}), att("Grip",{steel:1,screw:5,polymer:1}) ] },

  { name:"ASSAULT RIFLE (AK)", type:"craft", materials:{steel:21,screw:135,barrel:1,spring:2,wood:1,polymer:68},
    attachments:[ att("Lunetă",{steel:2,screw:10,polymer:2,lupa:1}), att("Baterie-Gloante",{steel:3,screw:20,spring:1,polymer:3}), att("Amortizor",{steel:3,screw:5,polymer:3}), att("Încărcător",{steel:2,screw:5,spring:1,polymer:2}), att("Grip",{steel:1,screw:5,polymer:1}), att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}) ] },
  { name:"COMPACT RIFLE", type:"craft", materials:{steel:19,screw:115,barrel:1,spring:2,wood:1,polymer:44},
    attachments:[ att("Încărcător",{steel:3,screw:30,spring:1,polymer:3}), att("Baterie-Gloante",{steel:3,screw:20,spring:1,polymer:3}) ] },
  { name:"CARABINE RIFLE", type:"craft", materials:{steel:18,screw:140,barrel:1,spring:2,wood:0,polymer:72},
    attachments:[ att("Grip",{steel:1,screw:5,polymer:1}), att("Încărcător",{steel:1,screw:5,spring:1,polymer:1}), att("Lunetă",{steel:2,screw:10,polymer:2,lupa:1}), att("Baterie-Gloante",{steel:3,screw:20,spring:1,polymer:3}), att("Amortizor",{steel:3,screw:5,polymer:3}), att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}) ] },
  { name:"ADVANCED RIFLE", type:"craft", materials:{steel:18,screw:145,barrel:1,spring:2,wood:0,polymer:78},
    attachments:[ att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}), att("Amortizor",{steel:3,screw:5,polymer:3}), att("Încărcător",{steel:1,screw:5,spring:1,polymer:1}), att("Lunetă",{steel:2,screw:10,polymer:2,lupa:1}) ] },

  // OFICIALA (pe bani) - ordinea ta
  { name:"Navy Pistol", type:"money", price:400000, attachments:[] },
  { name:"VINTIGE PISTOL", type:"money", price:25000,
    attachments:[ att("Încărcător",{steel:1,screw:5,spring:1,polymer:1}), att("Amortizor",{steel:2,screw:5,polymer:2}) ] },
  { name:"DB", type:"money", price:250000, attachments:[] },
  { name:"ASSAULTRIFE MK2 (AK)", type:"money", price:70000,
    attachments:[
      att("Lunetă-Mica",{steel:2,screw:10,polymer:2,lupa:1}),
      att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}),
      att("Încărcător",{steel:2,screw:5,spring:1,polymer:2}),
      att("Lunetă-Mare",{steel:2,screw:12,polymer:2,lupa:1}),
      att("Grip",{steel:1,screw:5,polymer:1}),
      att("Țeavă",{steel:4,screw:16,polymer:4}),
      att("Heavy Dutty Muzzle Brake",{steel:1,screw:4,polymer:1}),
      att("Vizor-Holografic",{steel:1,screw:8,polymer:1,lupa:1}),
      att("Flat-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Slanded-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Amortizor",{steel:3,screw:5,polymer:3}),
      att("Tactical-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Precision-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Split-End-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Fat-End-Muzzle-Brake",{steel:1,screw:4,polymer:1})
    ]},
  { name:"HEAVYRIFLE", type:"money", price:60000,
    attachments:[
      att("Lanternă",{steel:1,screw:5,polymer:1,bec:1,lupa:1}),
      att("Încărcător",{steel:1,screw:5,spring:1,polymer:1}),
      att("Lunetă",{steel:2,screw:10,polymer:2,lupa:1}),
      att("Amortizor",{steel:3,screw:5,polymer:3}),
      att("Grip",{steel:1,screw:5,polymer:1})
    ]},
  { name:"COMBAT MG", type:"money", price:120000,
    attachments:[
      att("Lunetă-Mare",{steel:2,screw:12,polymer:2,lupa:1}),
      att("Încărcător",{steel:1,screw:5,spring:1,polymer:1}),
      att("Grip",{steel:1,screw:5,polymer:1}),
      att("Lunetă-Medie",{steel:2,screw:10,polymer:2,lupa:1}),
      att("Țeavă",{steel:4,screw:16,polymer:4}),
      att("Vizor holografic",{steel:1,screw:8,polymer:1,lupa:1}),
      att("Slanded-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Fat-End-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Heavy Dutty-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Precision-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Tactical-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Flat-Muzzle-Brake",{steel:1,screw:4,polymer:1}),
      att("Split-End-Muzzle-Brake",{steel:1,screw:4,polymer:1})
    ]},
  { name:"GUSENBERG", type:"money", price:45000, attachments:[] },
  { name:"MG", type:"money", price:90000, attachments:[] },
];

/* =========================
   CATEGORII (fără “(Craft)”)
========================= */
function categoryOf(name){
  const pistols = new Set(["PISTOL","COMBAT PISTOL","PISTOL MK2","CERAMIC PISTOL","PISTOL WM29 (XM3)"]);
  const smgs = new Set(["MICRO SMG","MACHINE PISTOL (Tec9)","MINI SMG","TEC PISTOL (Tactical SMG)","SMG","COMBAT PDW"]);
  const rifles = new Set(["ASSAULT RIFLE (AK)","COMPACT RIFLE","CARABINE RIFLE","ADVANCED RIFLE"]);
  if(pistols.has(name)) return "Pistoale";
  if(smgs.has(name)) return "SMG";
  if(rifles.has(name)) return "Rifle";
  return "OFICIALA";
}

/* =========================
   UI Elements
========================= */
const weaponSearch = document.getElementById("weaponSearch");
const searchResults = document.getElementById("searchResults");
const weaponSelect = document.getElementById("weaponSelect");
const bulletsSelect = document.getElementById("bulletsSelect");
const attachmentsList = document.getElementById("attachmentsList");
const noAttach = document.getElementById("noAttach");

const bulletsStep = document.getElementById("bulletsStep");
const attachmentsStep = document.getElementById("attachmentsStep");
const qtyStep = document.getElementById("qtyStep");

const ammoHint = document.getElementById("ammoHint");
const attachmentsHint = document.getElementById("attachmentsHint");

const fullKitBtn = document.getElementById("fullKitBtn");
const noKitBtn = document.getElementById("noKitBtn");

const calcBtn = document.getElementById("calcBtn");
const addToCartBtn = document.getElementById("addToCartBtn");
const resultDiv = document.getElementById("result");

const cartList = document.getElementById("cartList");
const cartResult = document.getElementById("cartResult");
const calcCartBtn = document.getElementById("calcCartBtn");
const clearCartBtn = document.getElementById("clearCartBtn");

/* =========================
   Helpers
========================= */
function hide(el){ el.classList.remove("show"); }
function show(el){ el.classList.add("show"); }

function resetFlow(){
  hide(bulletsStep); hide(attachmentsStep); hide(qtyStep);
  resultDiv.style.display="none";
  bulletsSelect.innerHTML = "";
  attachmentsList.innerHTML = "";
  ammoHint.textContent = "";
  attachmentsHint.textContent = "";
  noAttach.checked = false;
}

function fillBullets(){
  bulletsSelect.innerHTML="";
  BULLET_OPTIONS.forEach(b=>{
    const opt=document.createElement("option");
    opt.value=String(b);
    opt.textContent=`${b} gloanțe`;
    bulletsSelect.appendChild(opt);
  });
}

function renderAttachments(w){
  attachmentsList.innerHTML="";
  attachmentsHint.textContent="";

  if(!w.attachments || w.attachments.length===0){
    attachmentsHint.textContent = "Această armă nu are atașamente.";
    return false;
  }
  w.attachments.forEach((a,idx)=>{
    const div=document.createElement("div");
    div.className="attach";
    div.innerHTML = `<label><input type="checkbox" class="attCheck" value="${idx}"> ${a.name}</label>`;
    attachmentsList.appendChild(div);
  });
  return true;
}

function getSelectedWeapon(){
  const idx = weaponSelect.value;
  if(idx==="") return null;
  return weapons[Number(idx)];
}

/* =========================
   Build weapon select (FĂRĂ popular/top)
========================= */
function buildWeaponSelect(filterText=""){
  const current = weaponSelect.value;
  weaponSelect.innerHTML = `<option value="">-- Selectează arma --</option>`;
  const ft = (filterText||"").trim().toLowerCase();

  const groups=new Map();
  weapons.forEach((w,idx)=>{
    const label=categoryOf(w.name);
    if(!groups.has(label)) groups.set(label, []);
    groups.get(label).push(idx);
  });

  const order=["Pistoale","SMG","Rifle","OFICIALA"];
  order.forEach(label=>{
    const arr=groups.get(label)||[];
    const og=document.createElement("optgroup");
    og.label=label;
    arr.forEach(i=>{
      const nm=weapons[i].name.toLowerCase();
      if(ft && !nm.includes(ft)) return;
      const opt=document.createElement("option");
      opt.value=String(i);
      opt.textContent=weapons[i].name;
      og.appendChild(opt);
    });
    if(og.children.length>0) weaponSelect.appendChild(og);
  });

  if(current!==""){
    const exists=[...weaponSelect.querySelectorAll("option")].some(o=>o.value===current);
    weaponSelect.value = exists ? current : "";
  }
}

/* =========================
   Search results (FĂRĂ “folosit x5”)
========================= */
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function highlight(text, query){
  const t=escapeHtml(text);
  const q=(query||"").trim();
  if(!q) return t;
  const re=new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), "ig");
  return t.replace(re, m=>`<mark>${escapeHtml(m)}</mark>`);
}
function renderSearchResults(query){
  const q=(query||"").trim().toLowerCase();
  let list=weapons.map((w,idx)=>({w,idx}));

  if(q){
    list=list.filter(x => x.w.name.toLowerCase().includes(q) || categoryOf(x.w.name).toLowerCase().includes(q));
  }
  list=list.slice(0,12);

  searchResults.innerHTML="";
  if(list.length===0){
    searchResults.innerHTML=`<div class="srItem"><span style="opacity:.75;">Niciun rezultat.</span></div>`;
    return;
  }

  list.forEach(({w,idx})=>{
    const div=document.createElement("div");
    div.className="srItem";
    div.innerHTML=`
      <div class="srLeft">
        <div><b>${highlight(w.name, query)}</b></div>
        <div style="opacity:.75;">${escapeHtml(categoryOf(w.name))} • ${w.type==="craft"?"Craft":"OFICIALA"}</div>
      </div>
      <div style="opacity:.55;">›</div>
    `;
    div.addEventListener("click", ()=>{
      weaponSelect.value=String(idx);
      handleWeaponChange();
    });
    searchResults.appendChild(div);
  });
}

/* =========================
   Attachments controls
========================= */
function syncNoAttachUI(){
  const checks=attachmentsList.querySelectorAll(".attCheck");
  if(noAttach.checked){
    checks.forEach(c=>{c.checked=false; c.disabled=true;});
    attachmentsList.style.display="none";
    attachmentsHint.textContent="Atașamentele NU sunt luate în calcul.";
  }else{
    checks.forEach(c=>{c.disabled=false;});
    attachmentsList.style.display="";
    // dacă arma are atașamente, nu mai afișăm mesajul “nu sunt luate...”
    if(checks.length>0) attachmentsHint.textContent="";
  }
}

function fullKit(){
  noAttach.checked=false;
  syncNoAttachUI();
  attachmentsList.querySelectorAll(".attCheck").forEach(c=>c.checked=true);
}
function noKit(){
  noAttach.checked=true;
  syncNoAttachUI();
}
fullKitBtn.addEventListener("click", fullKit);
noKitBtn.addEventListener("click", noKit);
noAttach.addEventListener("change", syncNoAttachUI);

/* =========================
   FLOW (default bullets=100, dar UI rămâne ok)
========================= */
function handleWeaponChange(){
  resultDiv.style.display="none";

  const w=getSelectedWeapon();
  if(!w){ resetFlow(); return; }

  // reset steps
  hide(bulletsStep); hide(attachmentsStep); hide(qtyStep);
  attachmentsList.innerHTML="";
  bulletsSelect.innerHTML="";
  noAttach.checked=false;
  ammoHint.textContent="";
  attachmentsHint.textContent="";

  // bullets
  fillBullets();
  show(bulletsStep);

  // ✅ default 100
  bulletsSelect.value="100";

  // mici info (opțional) – NU mai afișăm textul “EXACT...”
  // ammoHint.textContent = "";

  // declanșăm pasul următor automat, dar fără să “strice” afișarea gloanțelor
  setTimeout(()=>{
    bulletsSelect.dispatchEvent(new Event("change"));
  }, 0);
}

function handleBulletsChange(){
  const w=getSelectedWeapon();
  if(!w) return;

  // attachments
  const hasAtt = renderAttachments(w);
  if(hasAtt){
    show(attachmentsStep);
    noAttach.checked=false;
    syncNoAttachUI();
  }else{
    hide(attachmentsStep);
  }

  // qty
  show(qtyStep);
}

weaponSelect.addEventListener("change", handleWeaponChange);
bulletsSelect.addEventListener("change", handleBulletsChange);

/* =========================
   CALCUL
========================= */
function estimateMaterialsCost(t){
  let cost=0;
  cost += (t.steel||0)*COST_STEEL;
  cost += costFromScrews(t.screw||0);
  cost += (t.polymer||0)*COST_POLYMER;
  return cost;
}

function computeOneSelection(sel){
  const w=weapons[sel.weaponIndex];
  const qty=Math.max(1, sel.qty||1);
  const bullets=sel.bullets||100;

  const baseTotals=emptyTotals();
  const attTotals=emptyTotals();
  const ammoTotals=emptyTotals();
  const grandTotals=emptyTotals();

  let costWeapon=0;
  let costAmmo=0;

  if(w.type==="craft"){
    sumInto(baseTotals, w.materials, qty);
  }else{
    costWeapon = (w.price||0)*qty;
  }

  const ammoOne=ammoExactInterpolated(w.name, bullets);
  ammoTotals.powder += (ammoOne.powder||0)*qty;
  costAmmo += (ammoOne.price||0)*qty;

  if(w.attachments && w.attachments.length && !sel.noAttach){
    (sel.selectedAtt||[]).forEach(i=>{
      const a=w.attachments[i];
      if(!a||!a.data) return;
      sumInto(attTotals, a.data, qty);
    });
  }

  sumInto(grandTotals, baseTotals, 1);
  sumInto(grandTotals, attTotals, 1);
  sumInto(grandTotals, ammoTotals, 1);

  const costMats=estimateMaterialsCost(grandTotals);
  const total=Math.round(costWeapon + costAmmo + costMats);

  return {w, qty, bullets, baseTotals, attTotals, ammoTotals, grandTotals, costWeapon, costAmmo, costMats, total};
}

function currentSelectionToObject(){
  const w=getSelectedWeapon();
  if(!w) return null;

  const qty=Math.max(1, parseInt(document.getElementById("qty").value||"1",10));
  const bullets=parseInt(bulletsSelect.value||"100",10);

  const selectedAtt=[];
  if(w.attachments && w.attachments.length && !noAttach.checked){
    document.querySelectorAll(".attCheck:checked").forEach(cb=>selectedAtt.push(Number(cb.value)));
  }
  return {weaponIndex:Number(weaponSelect.value), bullets, qty, noAttach:!!noAttach.checked, selectedAtt};
}

calcBtn.addEventListener("click", ()=>{
  const sel=currentSelectionToObject();
  if(!sel){ alert("Selectează o armă!"); return; }

  const out=computeOneSelection(sel);

  resultDiv.style.display="block";
  resultDiv.innerHTML=`
    <h3>Rezultat</h3>

    <div class="grid">
      <div class="box">
        <div><b>Arma:</b> ${out.w.name}</div>
        <div><b>Categoria:</b> ${categoryOf(out.w.name)}</div>
        <div><b>Tip:</b> ${out.w.type==="craft" ? "Craft" : "OFICIALA"}</div>
        <div><b>Arme:</b> ${out.qty}</div>
        <div><b>Gloanțe:</b> ${out.bullets}</div>
      </div>

      <div class="box">
        <div style="opacity:.75;">Total</div>
        <div style="font-size:22px;font-weight:900;">${out.total.toLocaleString()}$</div>
        <hr>
        <div><b>Cost armă:</b> ${Math.round(out.costWeapon).toLocaleString()}$</div>
        <div><b>Cost gloanțe:</b> ${Math.round(out.costAmmo).toLocaleString()}$</div>
        <div><b>Cost materiale:</b> ${Math.round(out.costMats).toLocaleString()}$</div>
      </div>
    </div>

    <hr>

    <div class="grid">
      <div class="box">
        <h3 style="margin-top:0;">Materiale (Total)</h3>
        Oțel: ${Math.round(out.grandTotals.steel||0)}<br>
        Șuruburi: ${Math.round(out.grandTotals.screw||0)}<br>
        Țeavă: ${Math.round(out.grandTotals.barrel||0)}<br>
        Arc: ${Math.round(out.grandTotals.spring||0)}<br>
        Lemn: ${Math.round(out.grandTotals.wood||0)}<br>
        Polimer: ${Math.round(out.grandTotals.polymer||0)}<br>
        Bec: ${Math.round(out.grandTotals.bec||0)}<br>
        Lupă: ${Math.round(out.grandTotals.lupa||0)}<br>
        Praf de pușcă: ${Math.round(out.grandTotals.powder||0)}<br>
      </div>

      <div class="box">
        <h3 style="margin-top:0;">Separat</h3>

        <b>Armă (Craft):</b><br>
        Oțel: ${Math.round(out.baseTotals.steel||0)} • Șuruburi: ${Math.round(out.baseTotals.screw||0)} • Țeavă: ${Math.round(out.baseTotals.barrel||0)} • Arc: ${Math.round(out.baseTotals.spring||0)} • Lemn: ${Math.round(out.baseTotals.wood||0)} • Polimer: ${Math.round(out.baseTotals.polymer||0)}

        <hr>

        <b>Atașamente:</b><br>
        Oțel: ${Math.round(out.attTotals.steel||0)} • Șuruburi: ${Math.round(out.attTotals.screw||0)} • Polimer: ${Math.round(out.attTotals.polymer||0)} • Bec: ${Math.round(out.attTotals.bec||0)} • Lupă: ${Math.round(out.attTotals.lupa||0)} • Arc: ${Math.round(out.attTotals.spring||0)}

        <hr>

        <b>Gloanțe:</b><br>
        Praf: ${Math.round(out.ammoTotals.powder||0)}
      </div>
    </div>
  `;
  resultDiv.scrollIntoView({behavior:"smooth", block:"start"});
});

/* =========================
   CART
========================= */
const CART_KEY="fivem_cart_v1";
let cart=[];

function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }
function loadCart(){
  try{
    const raw=localStorage.getItem(CART_KEY);
    cart = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(cart)) cart=[];
  }catch(e){ cart=[]; }
}

function renderCart(){
  cartList.innerHTML="";
  cartResult.style.display="none";
  if(cart.length===0){
    cartList.innerHTML=`<div style="opacity:.75;">Coșul e gol.</div>`;
    return;
  }
  cart.forEach((it,idx)=>{
    const w=weapons[it.weaponIndex];
    const chips=[];
    chips.push(`<span class="mini">${w.type==="craft"?"Craft":"OFICIALA"}</span>`);
    chips.push(`<span class="mini">${it.qty} arme</span>`);
    chips.push(`<span class="mini">${it.bullets} gl</span>`);
    chips.push(`<span class="mini">${it.noAttach ? "fără ataș." : (it.selectedAtt?.length||0)+" ataș."}</span>`);

    const div=document.createElement("div");
    div.className="cartItem";
    div.innerHTML=`
      <div class="cartTitle">
        <div>
          <b>${w.name}</b>
          <div style="opacity:.75;">${categoryOf(w.name)} • ${w.type==="craft"?"Craft":"OFICIALA"}</div>
        </div>
        <div class="cartMeta">${chips.join("")}</div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="btn secondary" data-act="dup" data-idx="${idx}">Duplică</button>
        <button class="btn danger" data-act="del" data-idx="${idx}">Șterge</button>
      </div>
    `;
    cartList.appendChild(div);
  });

  cartList.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const idx=Number(btn.getAttribute("data-idx"));
      const act=btn.getAttribute("data-act");
      if(act==="del"){
        cart.splice(idx,1);
        saveCart(); renderCart();
      }else if(act==="dup"){
        cart.splice(idx+1,0, JSON.parse(JSON.stringify(cart[idx])));
        saveCart(); renderCart();
      }
    });
  });
}

addToCartBtn.addEventListener("click", ()=>{
  const sel=currentSelectionToObject();
  if(!sel){ alert("Selectează o armă!"); return; }
  cart.push(sel);
  saveCart();
  renderCart();
});

clearCartBtn.addEventListener("click", ()=>{
  cart=[];
  saveCart();
  renderCart();
});

calcCartBtn.addEventListener("click", ()=>{
  if(cart.length===0){ alert("Coșul e gol."); return; }

  const totalTotals=emptyTotals();
  let sumWeapon=0, sumAmmo=0, sumMats=0, sumAll=0;

  cart.forEach(sel=>{
    const out=computeOneSelection(sel);
    sumInto(totalTotals, out.grandTotals, 1);
    sumWeapon += out.costWeapon;
    sumAmmo += out.costAmmo;
    sumMats += out.costMats;
    sumAll += out.total;
  });

  cartResult.style.display="block";
  cartResult.innerHTML=`
    <h3>Total Coș</h3>
    <div class="grid">
      <div class="box">
        <div style="opacity:.75;">Total</div>
        <div style="font-size:22px;font-weight:900;">${Math.round(sumAll).toLocaleString()}$</div>
        <hr>
        <div><b>Cost arme:</b> ${Math.round(sumWeapon).toLocaleString()}$</div>
        <div><b>Cost gloanțe:</b> ${Math.round(sumAmmo).toLocaleString()}$</div>
        <div><b>Cost materiale:</b> ${Math.round(sumMats).toLocaleString()}$</div>
      </div>

      <div class="box">
        <h3 style="margin-top:0;">Materiale (Total)</h3>
        Oțel: ${Math.round(totalTotals.steel||0)}<br>
        Șuruburi: ${Math.round(totalTotals.screw||0)}<br>
        Țeavă: ${Math.round(totalTotals.barrel||0)}<br>
        Arc: ${Math.round(totalTotals.spring||0)}<br>
        Lemn: ${Math.round(totalTotals.wood||0)}<br>
        Polimer: ${Math.round(totalTotals.polymer||0)}<br>
        Bec: ${Math.round(totalTotals.bec||0)}<br>
        Lupă: ${Math.round(totalTotals.lupa||0)}<br>
        Praf de pușcă: ${Math.round(totalTotals.powder||0)}<br>
      </div>
    </div>
  `;
  cartResult.scrollIntoView({behavior:"smooth", block:"start"});
});

/* =========================
   SEARCH bind
========================= */
weaponSearch.addEventListener("input", (e)=>{
  const q=e.target.value;
  buildWeaponSelect(q);
  renderSearchResults(q);
  if(weaponSelect.value==="") resetFlow();
});

/* =========================
   INIT
========================= */
function init(){
  buildWeaponSelect("");
  renderSearchResults("");
  resetFlow();
  loadCart();
  renderCart();
}
init();
</script>

</body>
</html>
